<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Stock Viewer</title>

<!-- ================= UI STYLE ================= -->
<style>
  :root {
   --shadow-card:    0 10px 30px rgba(0,0,0,.08);
   --shadow-control: 0 6px 16px rgba(0,0,0,.08);
   --shadow-image:   0 4px 12px rgba(0,0,0,.12);
   --shadow-float:   0 12px 36px rgba(0,0,0,.12);
 }
  
  html, body {
  margin: 0;
  padding: 0;

  width: 100%;
  max-width: 100%;
  overflow-x: hidden;   /* üî¥ ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡πÉ‡∏à */

  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f2f2f7;
}
  header{
  padding:
    calc(env(safe-area-inset-top, 0px) + 20px)
    16px
    18px;
  font-size:22px;
  font-weight:600;

  /* üîπ Visual */
  background:rgba(255,255,255,.65);
  backdrop-filter:blur(30px) saturate(180%);
  -webkit-backdrop-filter:blur(30px) saturate(180%);
  border-bottom: 1px solid rgba(255,255,255,.4);

  box-shadow:
    0 8px 28px rgba(0,0,0,.06),
    inset 0 -1px 0 rgba(255,255,255,.35);

  /* üîπ Position */
  position:sticky;
  top:0;
  z-index:50;

  /* üîπ Layout (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) */
  display:flex;
  justify-content:space-between;
  align-items:center;

  /* üî¥ FIX ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç */
  min-height:110px;     /* ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Search + Filter (STEP 5.2) */  
  box-sizing:border-box;

  transition:
    padding .45s cubic-bezier(.34,1.56,.64,1),
    min-height .35s ease,
    background .3s ease,
    box-shadow .3s ease;
  }

  header.scrolled{
   padding:
     calc(env(safe-area-inset-top, 0px) + 12px)
     16px
     10px;
   min-height: 72px;
   background: rgba(255,255,255,.85);
   box-shadow:
     0 12px 36px rgba(0,0,0,.12),
     inset 0 -1px 0 rgba(255,255,255,.5);
 } 

/* ================= SHOP TITLE GLOW ================= */
 .shop-title{
   font-weight:700;
   font-size:22px;
   color:#fff;
   letter-spacing:.3px;
   text-shadow:
     0 0 8px rgba(255,255,255,.6),
     0 0 16px rgba(255,255,255,.35);
 }

/* ================= ADMIN TITLE GLOW ================= */
.admin-title{
  font-weight:700;
  font-size:22px;
  color:#fff;
  letter-spacing:.3px;
  text-shadow:
    0 0 6px rgba(255,255,255,.65),
    0 0 18px rgba(255,255,255,.35);
}
  
  .badge{
    background:#ff3b30;color:#fff;
    border-radius:12px;padding:2px 8px;
    font-size:12px;
  }
  .container{padding:16px;display:grid;gap:16px;}
  
  .card{
    background: rgba(255,255,255,.72);
  backdrop-filter: blur(20px) saturate(160%);
  -webkit-backdrop-filter: blur(20px) saturate(160%);
  border-radius:18px;
  padding:14px;
  cursor:pointer;
  box-shadow: var(--shadow-card);
  }
  .name{
  font-weight:600;
  line-height:1.35;

  display:-webkit-box;
  -webkit-line-clamp:2;      /* ‡∏à‡∏≥‡∏Å‡∏±‡∏î 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
  -webkit-box-orient:vertical;

  overflow:hidden;
  word-break:break-word;
}
  .price{color:#007aff;margin-top:4px;}
  .stock{font-size:14px;color:#666;}

  .backdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.25);
  backdrop-filter: blur(2px);
  display: none;
  z-index: 100;
}

.sheet{
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;

  background: rgba(255,255,255,.85);
  backdrop-filter: blur(28px);
  -webkit-backdrop-filter: blur(28px);
  border-radius: 22px 22px 0 0;
  box-shadow: var(--shadow-float);

  padding: 20px 20px 24px; /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏¢‡∏≠‡∏∂‡∏î‡∏≠‡∏±‡∏î */

  /* ‚úÖ CORE FIX */
  max-height: calc(100dvh - 40px);   /* ‡πÉ‡∏ä‡πâ dvh ‡πÅ‡∏ó‡∏ô vh */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;

  transform: translateY(100%);
  transition: transform .35s cubic-bezier(.22,.61,.36,1);

  z-index: 101;
}

.sheet.show{
  transform: translateY(0);
}

.sheet h3{
  margin:0 0 12px;
}



/* ================= BASE INPUT (NEUTRAL) ================= */
input,
select {
  width: 100%;
  box-sizing: border-box;
  outline: none;
  font-family: inherit;
  background: rgba(255,255,255,.9);
  color: #111;                 /* üî¥ FIX: text ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡πÉ‡∏ô light mode */
}

/* üî¥ NEW: textarea base style (Light mode fix) */
textarea {
  width: 100%;
  box-sizing: border-box;
  font-family: inherit;
  background: #fff;
  color: #111;
  border: 1px solid #ddd;
  border-radius: 12px;
}
  
input::placeholder,
textarea::placeholder {
  color: #999;                 /* üî¥ FIX: placeholder ‡πÑ‡∏°‡πà‡∏à‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
}  

input:focus,
select:focus {
  border-color: #007aff;
}

/* ================= STEP 3: FORM CONSISTENT ================= */

.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 14px;
}

.form-group label {
  font-size: 13px;
  color: #666;
}

/* ================= FORM INPUT (UNIFIED) ================= */

/* ‡∏ó‡∏∏‡∏Å input / select ‡πÉ‡∏ô form + ‡∏Å‡∏±‡∏ô iOS zoom */
.form-group input,
.form-group select {
  width: 100%;
  height: 44px;
  padding: 10px 12px;

  font-size: 16px;          /* üî¥ FIX iOS ZOOM */
  line-height: 1.2;

  border-radius: 12px;
  border: 1px solid #ddd;
  box-sizing: border-box;
  background: #fff;
  font-family: inherit;
}

/* number ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô text (iOS / Android) */
.form-group input[type="number"] {
  appearance: textfield;
  -moz-appearance: textfield;
}

/* focus state */
.form-group input:focus,
.form-group select:focus {
  border-color: #007aff;
  outline: none;
}

  /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */
button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

 .btn-remove{
  padding:6px 12px;
  border-radius:10px;
  background:#ff3b30;
  color:#fff;
  border:none;

  font-size:13px;
  font-weight:600;
  line-height:1;

  cursor:pointer;
 }
  /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */
.btn-remove:active {
  transform: scale(0.95);
}

/* interaction */
.btn-danger:active,
.btn-outline:active {
  transform: scale(0.97);
}
  
/* ================= BUTTON SYSTEM ================= */

.btn {
  padding: 12px;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  font-size: 15px;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition:
    transform .18s cubic-bezier(.34,1.56,.64,1),
    box-shadow .18s ease;
}

/* Primary */
.btn-primary {
  background: #007aff;
  color: #fff;
}

/* Secondary (soft green) */
.btn-secondary {
  background: #34c759;
  color: #fff;
}

/* Outline (cancel / back) */
.btn-outline {
  background: #f2f2f7;
  color: #333;
  border: 1px solid #ddd;
}

/* Interaction */
.btn:active {
  transform: scale(0.94);
}

  .cart-item{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:12px;
  padding:12px 0;
  border-bottom:1px dashed rgba(0,0,0,.08);
  }

 .cart-item > div:first-child {
   flex: 1;
   min-width: 0; /* üî¥ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡πÉ‡∏´‡πâ text ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î‡πÑ‡∏î‡πâ */
 }

 .cart-item > div:last-child {
   flex-shrink: 0;
   text-align: right;
 }

 .cart-item .price{
   margin-top:2px;
 }

 .cart-item-right{
   display:flex;
   align-items:center;   /* üî¥ ‡∏´‡∏±‡∏ß‡πÉ‡∏à: align ‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤ */
   gap:8px;
 }
 

  .total{
  font-size:18px;
  font-weight:700;
  text-align:right;
  margin-top:16px;
  padding-top:12px;
  border-top:1px solid rgba(0,0,0,.08);
  }

#cartSheet .btn-primary{
  margin-top:16px;
  margin-bottom:12px;
}

#cartSheet{
  padding-bottom: calc(env(safe-area-inset-bottom) + 28px);
}
  
  /* ===== Order Preview (Hidden) ===== */
  #orderPreview {
    width: 360px;
    padding: 16px;
    background: #fff;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    display: none;
  }
  #orderPreview h2 {
    margin: 0 0 8px;
  }
  #orderPreview .item {
    display:flex;
    justify-content:space-between;
    margin-bottom:6px;
    font-size:14px;
  }
  #orderPreview .footer {
    margin-top:12px;
    font-weight:700;
    text-align:right;
  }

/* ================= HEADER SEARCH (iOS-LIKE) ================= */

.search-wrap {
  display: flex;
  align-items: center;
  position: relative;
  max-width: calc(100% - 44px);
}

.search-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: none;
  background: rgba(255,255,255,.6);
  backdrop-filter: blur(10px);
  font-size: 18px;
  cursor: pointer;

  transition:
    transform .18s cubic-bezier(.25,.46,.45,.94),
    background .2s ease;
}

.search-btn:active {
  transform: scale(.92);
}

.search-input {
   width: 100%;                /* üî¥ FIX: ‡πÑ‡∏°‡πà animate layout */
   max-width: 0;               /* üî¥ FIX: ‡πÉ‡∏ä‡πâ max-width control ‡πÅ‡∏ó‡∏ô */
   opacity: 0;
   margin-left: 8px;
   height: 40px;
   padding: 8px 12px;

   font-size: 16px;
   border-radius: 12px;
   border: 1px solid rgba(0,0,0,.12);

   background: rgba(255,255,255,.85);
   color: #111;
   backdrop-filter: blur(14px);

   transform: translateX(-6px) scale(.96);
   pointer-events: none;

   transition:
     max-width .45s cubic-bezier(.34,1.56,.64,1),
     opacity .18s ease,
     transform .45s cubic-bezier(.34,1.56,.64,1);
}

/* üî• ACTIVE STATE */
.search-wrap.active .search-input {
  max-width: 260px; /* üî¥ FIX: ‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á ‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏° flex */
  opacity: 1;
  transform: translateX(0) scale(1);
  pointer-events: auto;
}

/* üîπ subtle focus glow (iOS feel) */
.search-input:focus {
  border-color: #007aff;
  box-shadow:
    0 0 0 3px rgba(0,122,255,.18);
  outline: none;
}

 /* ================= FILTER ICON DROPDOWN ================= */
 .filter-wrap{ position:relative; }

 .filter-btn{
   width:40px;
   height:40px;
   border-radius:50%;
   border:none;
   background:rgba(255,255,255,.6);
   backdrop-filter:blur(12px);
   font-size:18px;
   cursor:pointer;
 }

 .filter-dropdown{
   position:absolute;
   top:52px;
   right:0;
   min-width:200px;
   padding:10px;
   border-radius:18px;
   background:rgba(255,255,255,.85);
   backdrop-filter:blur(24px);
   box-shadow:var(--shadow-float);
   display:none;
   flex-direction:column;
   gap:6px;
 }

 .filter-dropdown.show{ display:flex; }

 .filter-item{
   padding:8px 12px;
   border-radius:12px;
   font-size:14px;
   cursor:pointer;
 }
  
/* ================= HEADER MENU BUTTON (iOS TACTILE) ================= */
.menu-btn{
  width:40px;
  height:40px;
  border:none;
  border-radius:50%;
  background:transparent;
  font-size:26px;
  cursor:pointer;

  display:flex;
  align-items:center;
  justify-content:center;

  transition:
    transform .18s cubic-bezier(.25,.46,.45,.94),
    background .2s ease;

  -webkit-tap-highlight-color: transparent;
}

.menu-btn:active{
  transform: scale(.92);
  background: rgba(0,0,0,.08);
}

@media (hover:hover){
  .menu-btn:hover{
    background: rgba(0,0,0,.06);
  }
}
  

  /* ================= PRODUCT CARD (HORIZONTAL) ================= */
.product-card {
  display: flex;
  gap: 12px;
  background: rgba(255,255,255,.72);
  backdrop-filter: blur(24px) saturate(160%);
  -webkit-backdrop-filter: blur(24px) saturate(160%);
  border-radius: 16px;
  padding: 12px;
  box-shadow: var(--shadow-card);
  align-items: center;
  cursor: pointer;
  transition:
    transform .25s cubic-bezier(.34,1.56,.64,1),
    box-shadow .25s ease;
}

@media (hover:hover){
  .product-card:hover{
    transform: translateY(-4px);
    box-shadow: var(--shadow-float);
  }
}  

.product-card .thumb {
  width: 80px;
  height: 80px;
  border-radius: 12px;
  object-fit: cover;
  background: #f0f0f0;
  flex-shrink: 0;
}

.product-card .info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.product-card .name {
  font-weight: 600;
  font-size: 16px;
}

.product-card .sku {
  font-size: 12px;
  color: #888;
}

.product-card .price {
  color: #007aff;
  font-weight: 600;
  margin-top: 2px;
}

.product-card .meta {
  display: flex;
  gap: 10px;
  align-items: center;
  font-size: 13px;
  color: #555;
}

.product-card:active {
  transform: scale(0.965);
  box-shadow:
    0 4px 14px rgba(0,0,0,.08);
}  

 .product-info-images {
   display: flex;
   gap: 8px;
   overflow-x: auto;
   margin: 12px 0;
 }

 .product-info-images img {
   height: 120px;
   border-radius: 12px;
   object-fit: cover;
 }

 .product-info-block {
   background: rgba(255,255,255,.65);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
   border-radius: 12px;
   padding: 12px;
   font-size: 14px;
 }
  
.sheet-product {
  min-height: 60dvh;   /* üî¥ ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ: 65‚Äì80 */
}  

/* ===== Status Badge (Viewer) ===== */
.status {
  padding: 3px 10px;
  min-height: 22px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
  line-height: 1;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

/* ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á */
.status.ready {
  background: rgba(52,199,89,.15);
  color: #34c759;
}

/* ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á */
.status.shipping {
  background: rgba(0,122,255,.15);
  color: #007aff;
}

/* ‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢ */
.status.warehouse {
  background: #eef3ff;
  color: #3b6cff;
}

/* ‡∏´‡∏°‡∏î */
.status.out {
  background: rgba(255,59,48,.15);
  color: #ff3b30;
}


.admin-action {
  display: flex;
  gap: 12px;
  margin-top: 16px;
}

.btn-approve {
  flex: 1;
  background: #007aff;
  color: #fff;
}

.btn-reject {
  flex: 1;
  background: #ff3b30;
  color: #fff;
}

.btn-approve:active,
.btn-reject:active {
  transform: scale(0.97);
}

/* ================= SIDE ADMIN MENU ================= */
.side-menu {
  position: fixed;
  top: 0;
  right: 0;

  width: min(65vw, 260px);
   /* ‚úÖ ‡∏•‡∏î‡∏•‡∏á‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≠‡∏î‡∏µ */
  height: 100vh;

  background: rgba(255,255,255,.82);
  backdrop-filter: blur(24px);
  -webkit-backdrop-filter: blur(24px);
  box-shadow: -6px 0 20px rgba(0,0,0,.12);

  z-index: 102;
  padding: 16px;            /* ‚úÖ ‡∏•‡∏î padding ‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÑ‡∏°‡πà‡∏≠‡∏∂‡∏î‡∏≠‡∏±‡∏î */

  transform: translateX(100%);
  transition: transform .28s ease;
  will-change: transform;
}

.side-menu.show {
  transform: translateX(0);
}

/* ===== UI DETAILS ===== */
.side-menu h3 {
  margin-top: 0;
  margin-bottom: 16px;
}

.side-menu .menu-btn {
  width: 100%;
  margin-bottom: 12px;
}

.loading {
  text-align: center;
  padding: 32px 16px;
  color: #666;
  font-size: 14px;
}

.loading::after {
  content: "‚Ä¶";
  animation: dots 1.4s infinite;
}

@keyframes dots {
  0%   { content: ""; }
  33%  { content: "."; }
  66%  { content: ".."; }
  100% { content: "..."; }
}

.menu-group {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.menu-group.danger {
  margin-top: 12px;
}

.btn-danger:active {
  transform: scale(0.97);
}

/* üîí iOS SAFARI ZOOM FIX */
input,
select,
textarea {
  font-size: 16px !important; /* üî¥ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î */
} 

/* ===== STOCK TIMELINE COLOR TAG ===== */
.timeline-tag {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 6px;
}

/* ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó */
.tag-in {
  background: #e6f9f0;
  color: #1e9c6a;
}

.tag-out {
  background: #fdecec;
  color: #d93025;
}

.tag-create {
  background: #eef3ff;
  color: #3b6cff;
}

.tag-adjust {
  background: #fff4e5;
  color: #e37400;
}

.tag-cancel {
  background: #f1f1f1;
  color: #666;
}

/* ===== ADMIN LOGIN TWEAK ===== */
#adminLoginSheet {
  padding-bottom: calc(env(safe-area-inset-bottom) + 24px); /* üî¥ ‡∏¢‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö */
}

/* ===== PREMIUM INPUT STYLE ===== */
.form-group input,
.form-group select,
#adminLoginSheet input,
#adminLoginSheet select {
  background: #f9f9fb;
  border: 1px solid #e5e5ea;
  box-shadow: inset 0 1px 2px rgba(0,0,0,.04);
  color: #111; /* üî¥ FIX: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö text ‡πÉ‡∏´‡πâ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô */
}

.form-group input:focus,
#adminLoginSheet input:focus {
  background: #fff;
  border-color: #007aff;
  box-shadow:
    0 0 0 2px rgba(0,122,255,.15),
    inset 0 1px 2px rgba(0,0,0,.04);
} 

/* ================= TOAST SYSTEM (GLOBAL FEEDBACK) ================= */

#toast-container {
  position: fixed;
  top: calc(env(safe-area-inset-top, 0px) + 24px);
  left: 50%;
  transform: translateX(-50%);
  z-index: 3000;

  display: flex;
  flex-direction: column;
  gap: 8px;

  pointer-events: none; /* üîí ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á interaction */
}

.toast {
  min-width: 260px;
  max-width: 90vw;
  padding: 12px 16px;

  border-radius: 14px;
  color: #fff;
  font-size: 14px;
  font-weight: 500;

  box-shadow: var(--shadow-float);              /* üî¥ ‡πÉ‡∏ä‡πâ token ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö */

  backdrop-filter: blur(18px) saturate(160%);   /* üî¥ ‡πÄ‡∏û‡∏¥‡πà‡∏° glass */
  -webkit-backdrop-filter: blur(18px) saturate(160%);

  animation: toast-slide-down .25s ease;
}

/* ===== Toast Variants ===== */
.toast.success { background: rgba(52,199,89,.92); }
.toast.error   { background: rgba(255,59,48,.92); }
.toast.warning { background: rgba(255,159,10,.92); }
.toast.info    { background: rgba(0,122,255,.92); }

/* ===== Animation (namespaced) ===== */
@keyframes toast-slide-down {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.hidden {
  display: none;
}

#loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

#loading-overlay.hidden {
  display: none !important;
}

.loading-box {
  background: rgba(255,255,255,.85);
  backdrop-filter: blur(24px);
  -webkit-backdrop-filter: blur(24px);
  padding: 20px 24px;
  border-radius: 12px;
  box-shadow: var(--shadow-float);
  text-align: center;
  min-width: 200px;
}

.spinner {
  width: 32px;
  height: 32px;
  border: 3px solid #ddd;
  border-top-color: #555;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 12px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

 /* ================= QTY INPUT (CART / ADD TO CART) ================= */

 /* wrapper ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô */
 .qty-input {
   position: relative;
 }

 /* input number ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô */
 .qty-input input[type="number"] {
   height: 52px;                    /* ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô ‚Üí ‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô control */
   padding: 12px 44px;              /* ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà icon */
   text-align: center;              /* ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á */

   font-size: 18px;
   font-weight: 600;

   border-radius: 16px;
   border: 1px solid rgba(0,0,0,.08);

   background: rgba(255,255,255,.9);
   backdrop-filter: blur(6px);

   box-shadow:
     inset 0 1px 2px rgba(0,0,0,.05),
     var(--shadow-control);

   transition: box-shadow .2s ease, border-color .2s ease;
 }

 /* focus = glow */
 .qty-input input[type="number"]:focus {
   border-color: #007aff;
   box-shadow:
     0 0 0 3px rgba(0,122,255,.18),
     inset 0 1px 2px rgba(0,0,0,.05);
 }

 /* ‡∏ã‡πà‡∏≠‡∏ô spin button ‡πÄ‡∏î‡∏¥‡∏° */
 .qty-input input[type="number"]::-webkit-inner-spin-button,
 .qty-input input[type="number"]::-webkit-outer-spin-button {
   -webkit-appearance: none;
   margin: 0;
 }

 /* ================= QTY ACTION (BOTTOM SAFE) ================= */
.qty-action {
  margin-top: 16px;
  padding-bottom: calc(env(safe-area-inset-bottom) + 12px);
}

/* üîí ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Admin) */
#adminProductEditSheet img {
  width: 100%;
  max-width: 120px;        /* üî¥ ‡∏•‡∏î‡∏•‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏≤‡∏Å */
  height: auto;
  aspect-ratio: 1 / 1;

  object-fit: cover;
  border-radius: 12px;

  margin: 8px auto 12px;   /* ‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢ */
  display: block;

  box-shadow: var(--shadow-image);
}

/* ‡∏•‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠‡∏ö ‡πÜ ‡∏£‡∏π‡∏õ */
#adminProductEditSheet {
  padding-top: 12px;
}

/* ‡πÉ‡∏´‡πâ form ‡∏ä‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô */
#adminProductEditSheet .form-group {
  margin-bottom: 10px;
}

/* ================= IMAGE FULLSCREEN VIEWER ================= */
#imageViewerSheet img {
  max-width: 100%;
  max-height: 100dvh;
  object-fit: contain;
}

#imageViewerSheet .close-btn {
  position: fixed;
  top: calc(env(safe-area-inset-top) + 14px);
  right: 14px;

  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: none;

  background: rgba(0,0,0,.6);
  color: #fff;
  font-size: 24px;

  display: flex;
  align-items: center;
  justify-content: center;

  cursor: pointer;
  z-index: 5;
}

 .image-viewer-sheet{
   padding: 0;                 /* üî¥ moved from inline */
   display: flex;              /* üî¥ moved from inline */
   align-items: center;        /* üî¥ moved from inline */
   justify-content: center;    /* üî¥ moved from inline */
   cursor: zoom-out;           /* üî¥ moved from inline */
 }

 .image-viewer-fullscreen{
   position: fixed;
   inset: 0;
   padding: 0;
   border-radius: 0;
   max-height: 100dvh;
   transform: none;
   z-index: 9999;
   background: transparent;
 }
 
/* =================================================
   üì¶ PRODUCT SHEET ‚Äì SHARED UI CLASSES
   ‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô inline-style ‡πÉ‡∏ô renderProductSheet
   (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö logic / flow)
   ================================================= */

/* ‚ùå ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î Sheet (‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô) */
.sheet-close-btn {
  position: absolute;
  top: calc(env(safe-area-inset-top) + 12px);
  right: 12px;

  width: 36px;
  height: 36px;

  border-radius: 50%;
  border: none;

  background: rgba(0,0,0,0.55);
  color: #fff;

  font-size: 22px;
  font-weight: 500;
  line-height: 1;

  display: flex;
  align-items: center;
  justify-content: center;

  cursor: pointer;
}

.sheet-close-btn:active {
  transform: scale(0.95);
}

/* üè∑Ô∏è ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô Product Sheet */
.product-title {
  margin-top: 4px;
}

.product-sku {
   color: #888;
   font-size: 13px;
   margin-bottom: 8px;
 }

 .product-detail-btn {
   margin-top: 12px;
 }
  
/* üñºÔ∏è ‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô) */
.product-image {
  width: 100%;
  aspect-ratio: 1 / 1;

  object-fit: cover;

  border-radius: 14px;
  margin: 12px 0;

  background: #f0f0f0;
}

/* üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Note) */
.product-note {
  margin-top: 10px;
  padding: 10px 12px;

  font-size: 14px;
  line-height: 1.45;
  color: #555;

  background: #f9f9fb;
  border-radius: 12px;
  border: 1px dashed rgba(0,0,0,.12);
}

/* üîπ Action Zone (‡∏õ‡∏∏‡πà‡∏°‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î) */
.product-action-zone {
  margin-top: 20px;
  padding-bottom: calc(env(safe-area-inset-bottom) + 12px);
}

/* üîß ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô */
.product-admin-hint {
  margin-top: 16px;
  color: #888;
  font-size: 14px;
}

 .admin-motto{
   font-size:13px;
   margin-left:7px;
   margin-top:4px;
   color:#ff3b30;
   opacity:.9;
   letter-spacing:.3px;
 }

 @media (prefers-color-scheme: dark){
   .admin-motto{
     color:#ff6b6b;
   }
 }
  
 @media (prefers-color-scheme: dark) {
   body {
     background: #0f0f12;
   }

   .toast{
    box-shadow: var(--shadow-float);
  }
   
  /* üîπ FLOATING BAR (DARK) */
  #floatingBar{
    background:rgba(28,28,30,.55);
    color:#f5f5f7;

    border:1px solid rgba(255,255,255,.08);

    box-shadow:
      0 10px 34px rgba(0,0,0,.6),
      inset 0 1px 0 rgba(255,255,255,.08);
  } 

   .product-image {
     background: rgba(44,44,46,.8);
   }
   
   .product-card,
   .card,
   .sheet,
   .side-menu,
   .loading-box {
     background: rgba(28,28,30,.72);
     color: #f5f5f7;
   }

   .filter-btn{
   background: rgba(44,44,46,.7);
 }

 .filter-dropdown{
   background: rgba(44,44,46,.9);
   color:#f5f5f7;
 }

 .filter-item:hover{
   background: rgba(255,255,255,.08);
 }
   
   .search-btn {
     background: rgba(44,44,46,.7);
   }

  .search-input {
    background: rgba(44,44,46,.9);
    border: 1px solid rgba(255,255,255,.08);
  }
   
   .product-note {
    background: rgba(44,44,46,.8);
    border: 1px dashed rgba(255,255,255,.08);
    color: #ddd;
  }

  .product-info-block {
    background: rgba(44,44,46,.75);
  }

  .qty-input input[type="number"] {
    background: rgba(44,44,46,.9);
    border: 1px solid rgba(255,255,255,.08);
    color: #fff;
  }

   input,
   select,
   textarea {
     background: rgba(44,44,46,.8);
     color: #fff;
     border: 1px solid rgba(255,255,255,.08);
   }
 }

 /* ================= DARK MODE LIQUID HEADER ================= */

@media (prefers-color-scheme: dark){
  .shop-title{
    color:#fff;
  }
  
  header{
    background: rgba(28,28,30,.55);
    border-bottom: 1px solid rgba(255,255,255,.06);

    box-shadow:
      0 8px 32px rgba(0,0,0,.5),
      inset 0 -1px 0 rgba(255,255,255,.06);
  }

  header.scrolled{
    background: rgba(28,28,30,.75);
    box-shadow:
      0 16px 42px rgba(0,0,0,.65),
      inset 0 -1px 0 rgba(255,255,255,.08);
  }
}

/* ================= FLOATING BOTTOM BAR ================= */

#floatingBar{
  position:fixed;
  left:16px;
  right:16px;
  transform:translateY(120%);
  bottom:calc(env(safe-area-inset-bottom) + 18px);

  max-width:520px;
  margin:0 auto;

  padding:12px 16px;   /* üî¥ smaller + tighter */

  display:flex;
  justify-content:space-between;
  align-items:center;

  border-radius:18px;  /* üî¥ proportional */

  background:rgba(255,255,255,.55);
  backdrop-filter:blur(28px) saturate(180%);
  -webkit-backdrop-filter:blur(28px);

  border:1px solid rgba(255,255,255,.65); /* üî¥ glass edge */

  box-shadow:
    0 8px 30px rgba(0,0,0,.12),
    inset 0 1px 0 rgba(255,255,255,.7);  /* üî¥ inner highlight */

  z-index:45; /* ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ header (50) ‡πÅ‡∏•‡∏∞ backdrop (100) */

  transition:
    transform .48s cubic-bezier(.34,1.56,.64,1),
    opacity .3s ease;
  
  opacity:0;
  pointer-events:none;
}

#floatingBar.bounce-in{
  animation: float-bounce .65s cubic-bezier(.34,1.56,.64,1);
}

@keyframes float-bounce{
  0%   { transform:translateY(120%) scale(.94); }
  60%  { transform:translateY(-6px) scale(1.02); }
  100% { transform:translateY(0) scale(1); }
}

#floatingBar .total-animate{
  animation: total-pop .25s ease;
}

@keyframes total-pop{
  0%   { transform:scale(.92); opacity:.6; }
  100% { transform:scale(1); opacity:1; }
}

#floatingBar:active{
  transform: translateY(0) scale(.97);
} 

#floatingBar.show{
  transform:translateY(0);
  opacity:1;
  pointer-events:auto;
}

/* üî¥ NEW: Smart Scroll Hide */
#floatingBar.scroll-hide{
  transform:translateY(120%);
  opacity:0;
  pointer-events:none;
}  

 /* ================= REDUCED MOTION SUPPORT ================= */
 @media (prefers-reduced-motion: reduce){

   /* üî¥ Disable global transitions */
   * {
     transition: none !important;
   }

   /* üî¥ Disable product card motion */
   .product-card{
     transition: none !important;
   }

   .product-card:hover{
     transform: none !important;
     box-shadow: var(--shadow-card) !important;
   }

   .product-card:active{
     transform: none !important;
   }

   /* üî¥ Disable floating bar animations */
   #floatingBar,
   #floatingBar.bounce-in{
     transition: none !important;
     animation: none !important;
   }

   #floatingBar .total-animate{
     animation: none !important;
   }

   /* üî¥ Disable toast slide animation */
   .toast{
     animation: none !important;
   }

   /* üî¥ Disable spinner rotation */
   .spinner{
     animation: none !important;
   }
 }
  
</style>
</head>
<body>

<!-- üî¥ HEADER (Mode-Based Controlled) -->
<header id="appHeader"></header>


<div id="app" class="container"></div>

<!-- ‚úÖ GLOBAL BACKDROP (‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏û‡∏≠) -->
<div id="globalBackdrop" class="backdrop" onclick="handleBackdropClick()"></div>

<!-- ================= VIEWER SHEETS ================= -->
<div id="productSheet" class="sheet sheet-product"></div>
<div id="qtySheet" class="sheet"></div>
<div id="cartSheet" class="sheet"></div>
<div id="confirmSheet" class="sheet"></div>
<div id="stockSheet" class="sheet"></div>  

<!-- üñºÔ∏è IMAGE VIEWER (FULLSCREEN) -->
<div id="imageViewerSheet" class="sheet image-viewer-sheet">
</div>

<!-- ================= ADMIN SHEETS ================= -->
<div id="adminLoginSheet" class="sheet"></div>
<div id="adminDashboardSheet" class="sheet"></div>
<div id="adminOrderSheet" class="sheet"></div>
<div id="adminStockSheet" class="sheet"></div>

<!-- üîπ Admin Side Menu -->
<div id="adminMenuSheet" class="side-menu"></div>

<!-- üîπ Admin Product -->
<div id="adminProductActionSheet" class="sheet"></div>
<div id="adminProductEditSheet" class="sheet"></div>

<!-- üîπ Stock (STEP 7.5) -->
<div id="adminStockActionSheet" class="sheet"></div>

<!-- üîπ ADD PRODUCT (STEP 7.6) ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà -->
<div id="adminAddProductSheet" class="sheet"></div>

  
<script>
/* ================= STEP 2: ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® backdrop (UPGRADED) ================= */
const backdrop = document.getElementById("globalBackdrop");
const cartSheet = document.getElementById("cartSheet");

// üîí ‡πÉ‡∏ä‡πâ state.ui.backdropLocked ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (single source of truth)
let allowOpenOrders = false;

  
/* ================= GLOBAL STATE (UPGRADED / SAFE) ================= */

const state = {
  mode: "viewer",
  viewerFilter: {
    status: "all"
  },
  search: "",
  viewerSearchOpen: false,
  products: [],
  selectedProduct: null,
  qty: 1,
  cart: [],
  lastOrder: null,

  // üîí viewer submit guard (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö createOrder)
  isSubmitting: false,

  admin: {
    loggedIn: false,
    user: null,
    token: null,
    orders: [],
    selectedOrder: null,
    logs: [],

    // üîí admin submit guard
    isSubmitting: false
  },

  // üß† SMART ADD PRODUCT DRAFT
  smartAddDraft: {
    price: "",
    stock: "",
    status: "ready",
    note: ""
  },

  ui: {
    overlayCount: 0,
    backdropLocked: false
  }
};

/* ================= CART STORAGE (VIEWER ONLY) ================= */

const CART_KEY = "luopanich_cart";

function saveCart() {
  try {
    localStorage.setItem(CART_KEY, JSON.stringify(state.cart));
  } catch (e) {
    console.warn("saveCart failed", e);
  }
}

function loadCart() {
  try {
    const raw = localStorage.getItem(CART_KEY);
    if (!raw) return;

    const parsed = JSON.parse(raw);
    if (Array.isArray(parsed)) {
      state.cart = parsed;
    }
  } catch (e) {
    console.warn("loadCart failed", e);
  }
}

function clearCartStorage() {
  localStorage.removeItem(CART_KEY);
}  
  
  /* ===== Feedback & Loading Utilities ===== */
function updateLoadingText(message){
  const text = document.getElementById("loading-text");
  if (text) {
    text.textContent = message;
  }
}

function showToast(message, type = 'info', timeout = 2500) {
  const container = document.getElementById('toast-container');
  if (!container) return;

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;

  container.appendChild(toast);

  // üîí limit toast count (optional but pro)
  if (container.children.length > 3) {
    container.removeChild(container.firstChild);
  }

  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 300);
  }, timeout);
}

// ---------- Central loading timer ----------
let _loadingTimer = null;
let _loadingShownAt = 0;
const MIN_LOADING_MS = 350; // ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö

function showLoading(message, timeoutMs = 60000) {
  const overlay = document.getElementById("loading-overlay");
  const text = document.getElementById("loading-text");
  if (!overlay || !text) return;

  text.textContent = message;
  overlay.classList.remove("hidden");

  // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö render
  overlay.offsetHeight;

  _loadingShownAt = Date.now();

  state.isSubmitting = true;
  state.ui.backdropLocked = true;
  if (backdrop) backdrop.style.display = "block";

  clearTimeout(_loadingTimer);
  _loadingTimer = setTimeout(() => {
    console.warn("[showLoading] auto-hide after timeout");
    safeHideLoading(true);
    showToast("‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤ ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß", "warning", 1800);
  }, timeoutMs);
}

/* ================= SAFE HIDE LOADING (SINGLE SOURCE OF TRUTH) ================= */
/**
 * ‚ùó IMPORTANT
 * - ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ safeHideLoading ‡πÅ‡∏Ñ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
 * - ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ
 */

function safeHideLoading(fromTimeout = false) {
  const overlay = document.getElementById("loading-overlay");

  const elapsed = Date.now() - (_loadingShownAt || 0);
  const delay = Math.max(0, MIN_LOADING_MS - elapsed);

  setTimeout(() => {
    try {
      if (overlay) overlay.classList.add("hidden");

      // üî• ‡∏´‡∏±‡∏ß‡πÉ‡∏à: ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå timer ‡∏Ç‡∏≠‡∏á showLoading
      if (_loadingTimer) {
        clearTimeout(_loadingTimer);
        _loadingTimer = null;
      }

      state.isSubmitting = false;
      state.ui.backdropLocked = false;

      if (state.ui.overlayCount === 0 && backdrop) {
        backdrop.style.display = "none";
      }

      console.log(
        "[safeHideLoading] loading closed",
        fromTimeout ? "(timeout)" : ""
      );

    } catch (e) {
      console.error("[safeHideLoading] failed", e);
    }
  }, delay);
}


// ---------- fetchWithTimeout ----------
async function fetchWithTimeout(input, init = {}, ms = 30000) {
  const controller = new AbortController();
  const signal = controller.signal;
  const id = setTimeout(() => controller.abort(), ms);

  try {
    const res = await fetch(input, { ...init, signal });

    // üîí ‡πÄ‡∏ä‡πá‡∏Ñ HTTP status ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
    if (!res.ok) {
      const text = await res.text();
      throw new Error(`HTTP ${res.status}: ${text}`);
    }

    return res;

  } catch (err) {
    if (err.name === "AbortError") {
      throw new Error("‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ä‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
    }
    throw err;
  } finally {
    clearTimeout(id);
  }
}
  

/* ================= API LAYER ================= */
const API_URL="https://script.google.com/macros/s/AKfycbzs0OLbJ7oa8WQxIXWYcx4X3NqfS3sCIaq9iV6Mh8oLWOqI9k71Qhei08zL2fbR2Eo/exec";

const fetchProducts = async () => {
  const res = await fetchWithTimeout(
   `${API_URL}?action=products`,
   {},
   15000
 );
  const json = await res.json();

  // üîí enforce standard response
  if (!json || json.success !== true || !Array.isArray(json.data)) {
    console.error("fetchProducts invalid response:", json);
    return []; // ‚úÖ ‡∏Ñ‡∏∑‡∏ô array ‡πÄ‡∏™‡∏°‡∏≠
  }

  return json.data;
};

function sortProducts(products) {
  if (!Array.isArray(products)) return [];

  return products.sort((a, b) =>
    String(a.productId || "").localeCompare(
      String(b.productId || ""),
      'th',
      {
        numeric: true,
        sensitivity: 'base'
      }
    )
  );
}
  
async function refreshProducts() {
  const list = await fetchProducts();

  state.products = sortProducts(list); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  renderProducts();
}

async function createOrder() {
  const total = state.cart.reduce(
   (s,i)=> s + Number(i.price) * Number(i.qty),
   0
 );

  const form = new URLSearchParams();
  form.append("action", "createOrder");
  form.append("items", JSON.stringify(state.cart));
  form.append("total", total);

  // ‡πÉ‡∏ä‡πâ fetchWithTimeout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô request ‡πÅ‡∏Ç‡∏ß‡∏ô
  const res = await fetchWithTimeout(API_URL, {
    method: "POST",
    body: form
  }, 15000);

  // üî¥ FIX: ‡πÄ‡∏ä‡πá‡∏Ñ HTTP status ‡∏Å‡πà‡∏≠‡∏ô
  if (!res.ok) {
    const text = await res.text();
    throw new Error(
      `CreateOrder HTTP ${res.status}: ${text}`
    );
  }

  const json = await res.json();

  // üî¥ FIX: validate response shape
  if (!json || json.success !== true || !json.data?.orderId) {
    throw new Error("Invalid createOrder response");
  }

  return json;
}

function openOverlay(el){
  if (!el || el.classList.contains("show")) return;

  el.classList.add("show");
  state.ui.overlayCount++;

  backdrop.style.display = "block";
}

function closeOverlay(el){
  if (!el || !el.classList.contains("show")) return;

  el.classList.remove("show");
  state.ui.overlayCount = Math.max(0, state.ui.overlayCount - 1);

  if (state.ui.overlayCount === 0 && !state.ui.backdropLocked) {
    backdrop.style.display = "none";

    // üî¥ FIX: reset floating bar momentum state
    const bar = document.getElementById("floatingBar");
    if (bar) bar.classList.remove("scroll-hide");
  }
}

async function adminStockIn(productId, qty, reason){
  if (!state.admin.token) {
    throw new Error("Not authenticated");
  }

  const form = new URLSearchParams();
  form.append("action", "stockIn");
  form.append("productId", productId);
  form.append("qty", qty);
  form.append("reason", reason || "");
  form.append("token", state.admin.token); // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î

  const res = await fetch(API_URL, {
    method: "POST",
    body: form
  });

  const json = await res.json();

  // üîí session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ / token ‡∏ú‡∏¥‡∏î
  if (json.error || json.success === false) {
    if (
      json.error === "Session expired" ||
      json.error === "Invalid token" ||
      json.error === "Missing token"
    ) {
      alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà");
      exitAdmin();
    }
    throw new Error(json.error || "Stock IN failed");
  }

  return json;
}


async function adminStockAdjust(productId, newQty, reason){
  if (!state.admin.token) {
    throw new Error("Not authenticated");
  }

  const form = new URLSearchParams();
  form.append("action", "stockAdjust");
  form.append("productId", productId);
  form.append("newQty", newQty);
  form.append("reason", reason || "");
  form.append("token", state.admin.token); // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î

  const res = await fetch(API_URL, {
    method: "POST",
    body: form
  });

  const json = await res.json();

  // üîí session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ / token ‡∏ú‡∏¥‡∏î
  if (json.error || json.success === false) {
    if (
      json.error === "Session expired" ||
      json.error === "Invalid token" ||
      json.error === "Missing token"
    ) {
      alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà");
      exitAdmin();
    }
    throw new Error(json.error || "Stock adjust failed");
  }

  return json;
}

  

/* ================= ADMIN API ================= */ // üî¥ ADD

async function adminApproveOrder(orderId) {
  if (state.admin.isSubmitting) return;
  state.admin.isSubmitting = true;

  try {
    if (!state.admin.token) {
      throw new Error("Not authenticated");
    }

    showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠...");

    const form = new URLSearchParams();
    form.append("action", "approveOrder");
    form.append("orderId", orderId);
    form.append("token", state.admin.token);

    const res = await fetch(API_URL, {
      method: "POST",
      body: form
    });

    const json = await res.json();

    if (json.error || json.success === false) {
      if (
        json.error === "Session expired" ||
        json.error === "Invalid token" ||
        json.error === "Missing token"
      ) {
        showToast("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà", "warning");
        exitAdmin();
      }
      throw new Error(json.error || "Approve order failed");
    }

    // ‚úÖ success
    showToast("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
    return json.data;

  } catch (err) {
    console.error(err);
    showToast(err.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ", "error");
    throw err;
  } finally {
  safeHideLoading();
  state.admin.isSubmitting = false;
 }
}

async function adminRejectOrder(orderId) {
  if (state.admin.isSubmitting) return;
  state.admin.isSubmitting = true;

  try {
    if (!state.admin.token) {
      throw new Error("Not authenticated");
    }

    showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠...");

    const form = new URLSearchParams();
    form.append("action", "rejectOrder");
    form.append("orderId", orderId);
    form.append("token", state.admin.token);

    const res = await fetch(API_URL, {
      method: "POST",
      body: form
    });

    const json = await res.json();

    if (json.error || json.success === false) {
      if (
        json.error === "Session expired" ||
        json.error === "Invalid token" ||
        json.error === "Missing token"
      ) {
        showToast("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà", "warning");
        exitAdmin();
      }
      throw new Error(json.error || "Reject order failed");
    }

    // ‚úÖ success
    showToast("‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success");
    return json.data;

  } catch (err) {
    console.error(err);
    showToast(
      err.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ",
      "error"
    );
    throw err;

  } finally {
    // ‚úÖ cleanup ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    safeHideLoading();
    state.admin.isSubmitting = false;
  }
}

async function fetchStockLogs() {
  if (!state.admin.token) {
    throw new Error("Not authenticated");
  }

  const form = new URLSearchParams();
  form.append("action", "stockLogs");
  form.append("token", state.admin.token);

  const res = await fetch(API_URL, {
    method: "POST",
    body: form
  });

  const json = await res.json();

  if (json.error || json.success === false) {
    if (
      json.error === "Session expired" ||
      json.error === "Invalid token" ||
      json.error === "Missing token"
    ) {
      alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà");
      exitAdmin();
    }

    throw new Error(json.error || "‡πÇ‡∏´‡∏•‡∏î Stock Logs ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }

  return json;
}


  

async function fetchOrders(){
  if (!state.admin.token) {
    throw new Error("Not authenticated");
  }

  const form = new URLSearchParams();
  form.append("action", "orders");
  form.append("token", state.admin.token);

  const res = await fetch(API_URL, {
    method: "POST",
    body: form
  });

  const json = await res.json();

  if (!json.success) {
    // üîí token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ / ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    if (
      json.error === "Session expired" ||
      json.error === "Invalid token"
    ) {
      alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà");
      exitAdmin(); // logout ‡∏ù‡∏±‡πà‡∏á frontend
    }
    throw new Error(json.error || "‡πÇ‡∏´‡∏•‡∏î Orders ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }

  // ‚úÖ ‡∏Ñ‡∏∑‡∏ô array ‡∏Ç‡∏≠‡∏á orders
  return json.data;
}
  
/* ================= STOCK CHECK ================= */
async function checkStockBeforeSubmit() {
  const latestProducts = await fetchProducts();

  for (const item of state.cart) {
    const product = latestProducts.find(
      p => p.productId === item.productId
    );

    if (!product) {
      return { ok:false, message:`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${item.name}` };
    }

    if (Number(product.stock) < Number(item.qty)) {
      return {
        ok:false,
        message:`${item.name} ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${product.stock} ‡∏ä‡∏¥‡πâ‡∏ô (‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${item.qty})`
      };
    }
  }

  return { ok:true };
}

/* ================= RENDER FUNCTIONS ================= */
 // üîí Global HTML Escape (XSS Guard)
 const esc = s =>
   String(s)
     .replace(/</g, "&lt;")
     .replace(/>/g, "&gt;");  
  
function openImageViewer(url){
  if (!url) return;

  const sheet = document.getElementById("imageViewerSheet");
  if (!sheet) return;

  // üî• reset ‡∏ú‡∏•‡∏Ç‡∏≠‡∏á .sheet ‡πÄ‡∏î‡∏¥‡∏°
  sheet.classList.add("image-viewer-fullscreen");

  sheet.innerHTML = `
    <!-- overlay background (‡∏£‡∏±‡∏ö click ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î) -->
 <div
   style="
     position:absolute;
     inset:0;
     background:#000;
   ">
 </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î -->
    <button
      class="close-btn"
      onclick="event.stopPropagation(); closeImageViewer()"
      style="
        position:absolute;
        top:16px;
        right:16px;
        z-index:2;
      ">
      √ó
    </button>

    <!-- ‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
 <img
   src="${url}"
   alt="preview"
   style="
     position:relative;
     z-index:1;
     width:100%;
     height:100%;
     object-fit:contain;
     cursor:default;
   "
 >
  `;

  openOverlay(sheet);
}
  
function closeImageViewer(){
  const sheet = document.getElementById("imageViewerSheet");
 if (!sheet) return;

 // üîí force close (‡πÑ‡∏°‡πà‡∏™‡∏ô state ‡∏Ñ‡πâ‡∏≤‡∏á)
 sheet.innerHTML = "";
 sheet.classList.remove("image-viewer-fullscreen");

 if (sheet.classList.contains("show")) {
   closeOverlay(sheet);
 }
}
 
 function openProductInfoSheet(p){
   const details = p.detailsText
     ? p.detailsText.split("\n").filter(Boolean)
     : [];

   const images = p.compareImages
     ? p.compareImages.split(",").map(s => s.trim())
     : [];

   const html = `
     <h3>${esc(p.name)}</h3>

     ${
       images.length
         ? `
           <div class="product-info-images">
 ${images.map(url => `
   <img src="${url}"
        style="cursor:zoom-in"
        onclick="openImageViewer('${url}')">
 `).join("")}
           </div>
         `
         : ""
     }

     ${
       details.length
         ? `
           <div class="product-info-block">
             <ul>
               ${details.map(d => `<li>${esc(d)}</li>`).join("")}
             </ul>
           </div>
         `
         : ""
     }

 <button class="btn btn-secondary"
   style="color:#fff;font-size:16px"
   onclick="closeProductInfoSheet()">
   ‡∏õ‡∏¥‡∏î
 </button>
   `;

 let sheet = document.getElementById("productInfoSheet");
 if (!sheet) {
   sheet = document.createElement("div");
   sheet.id = "productInfoSheet";
   sheet.className = "sheet";
   document.body.appendChild(sheet);
 }
 sheet.innerHTML = html;
 openOverlay(sheet);
 }

function closeProductInfoSheet(){
  const sheet = document.getElementById("productInfoSheet");
  if (sheet && sheet.classList.contains("show")) {
    closeOverlay(sheet);
  }
}  
  
function renderProducts(){
  const app = document.getElementById("app");

  const escapeHTML = (str="") =>
    str.replace(/</g,"&lt;").replace(/>/g,"&gt;");
  
  // üîí GUARD ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
  if (!Array.isArray(state.products)) {
    console.error("renderProducts: products is not array", state.products);
    app.innerHTML = `
      <div style="
        text-align:center;
        color:#d93025;
        margin-top:40px;
        font-size:15px;
      ">
        ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ
      </div>
    `;
    return;
  }

  app.innerHTML = "";
  let found = false;

  state.products.forEach(p => {
    const stockNum = Number(p.stock);

    // ‚ùå ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢ (viewer ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
    if (state.mode === "viewer" && !p.active) return;

    // üîç SEARCH FILTER (‡∏ä‡∏∑‡πà‡∏≠ + ‡∏£‡∏´‡∏±‡∏™)
    if (state.search) {
      const text = (p.name + p.productId).toLowerCase();
      if (!text.includes(String(state.search).toLowerCase())) return;
    }

   // üîç STATUS FILTER (Viewer only, use resolved status)
   const resolvedStatus =
   stockNum <= 0
     ? "out"
     : String(p.status || "ready")
         .trim()
         .toLowerCase();

   if (
     state.mode === "viewer" &&
     state.viewerFilter &&
     state.viewerFilter.status !== "all"
   ) {
     if (resolvedStatus !== state.viewerFilter.status) return;
   }
    
/* ================= STATUS LOGIC ================= */
const statusMap = {
  ready:     "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á",
  shipping:  "‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á",
  warehouse: "‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢",
  out:       "‡∏´‡∏°‡∏î"
};

const statusKey = resolvedStatus;
let statusClass = statusKey;
let statusText  = statusMap[statusKey] || "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á";

    /* ================= CARD ================= */
    const card = document.createElement("div");
    card.className = "product-card";

    card.onclick = () => {
      if (state.mode === "admin") {
        openAdminProductAction(p);
      } else {
        openProduct(p);
      }
    };

    card.innerHTML = `
      <img class="thumb"
        src="${p.image ? p.image : "about:blank"}"
        alt="${p.name}"
        onerror="this.style.display='none'">

      <div class="info">
        <div class="name">${escapeHTML(p.name)}</div>
        <div class="sku">‡∏£‡∏´‡∏±‡∏™: ${escapeHTML(p.productId)}</div>
        <div class="price">‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø${Number(p.price).toLocaleString()}</div>

        <div class="meta">
          <span class="qty">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${p.stock}</span>
          <span class="status ${statusClass}">
            ${statusText}
          </span>
        </div>
      </div>
    `;

    app.appendChild(card);
    found = true;
  });

  // ‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  if (!found) {
    app.innerHTML = `
      <div style="
        text-align:center;
        color:#888;
        margin-top:40px;
        font-size:15px;
      ">
        ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      </div>
    `;
  }
}

function renderProductSheet(){
  const p = state.selectedProduct;
  const productSheet = document.getElementById("productSheet");
  if (!productSheet || !p) return;

  productSheet.innerHTML = `
    <!-- ‚ùå CLOSE BUTTON (TOP-RIGHT) -->
 <button
   class="sheet-close sheet-close-btn"
   onclick="closeOverlay(productSheet)"
   aria-label="Close"
 >
      √ó
    </button>

    <h3 class="product-title">${esc(p.name)}</h3>

    <div class="product-sku">
      ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${p.productId}
    </div>

    <!-- ‚úÖ FIX IMAGE -->
 <img 
   src="${p.image || ''}"
   alt="${p.name}"
   class="product-image"
 >

    <div class="price">‡∏ø${p.price}</div>
    <div class="stock">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${p.stock} ‡∏ä‡∏¥‡πâ‡∏ô</div>
    
     ${
      p.detailsText || p.compareImages
        ? `
          <button
            class="btn btn-outline product-detail-btn"
            onclick="openProductInfoSheet(state.selectedProduct)">
            üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          </button>
        `
        : ""
    }

     ${
   p.note
     ? `
<div class="product-note">
         üìù ${String(p.note)
       .replace(/</g, "&lt;")
       .replace(/>/g, "&gt;")}
       </div>
     `
     : ""
 }

    ${
      state.mode === "viewer"
        ? `
          <!-- üîπ ACTION ZONE -->
<div class="product-action-zone">
            <button
              class="btn btn-primary"
              onclick="openQtySheet()"
            >
              ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
            </button>
          </div>
        `
        : `
 <div class="product-admin-hint">
   üîß ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
 </div>
        `
    }
  `;
}
  
function renderCart(){
  cartSheet.innerHTML="<h3>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</h3>";

  if(state.cart.length===0){
    cartSheet.innerHTML+=`<div style="color:#888">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</div>
`;
    return;
  }

  state.cart.forEach((i,idx)=>{
  cartSheet.innerHTML+=`
    <div class="cart-item">
      <div>
        <div class="name">${esc(i.name)}</div>
        <div style="font-size:12px;color:#888">
          ‡∏£‡∏´‡∏±‡∏™: ${i.productId}
        </div>
        <div class="price">‡∏ø${i.price}</div>
      </div>
 <div class="cart-item-right">
   <div style="font-size:14px;color:#555">
     ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${i.qty || 1}
   </div>
   <button class="btn-remove"
     onclick="removeItem(${idx})">
     ‡∏•‡∏ö
   </button>
 </div>
    </div>`;
  });

const total = state.cart.reduce(
   (s,i)=> s + Number(i.price) * Number(i.qty),
   0
 );

cartSheet.innerHTML += `
  <div class="total">Total: ‡∏ø${total}</div>
  <button class="btn btn-primary"
    onclick="openConfirm()">
    ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
  </button>
`;
}

function renderBadge(){
  const cartButton = document.getElementById("cartButton");
  const cartBadge  = document.getElementById("cartBadge");

  // üî¥ CHANGED: allow floating bar to sync even if header cart button removed
  if (cartButton && cartBadge) {
    const count = state.cart.length;

    if (count > 0) {
      cartButton.style.display = "block";
      cartBadge.textContent = count;
    } else {
      cartButton.style.display = "none";
    }
  }
  
  // üî¥ NEW: sync floating bar ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà badge update
  renderFloatingBar();
}

/* ================= FLOATING BAR RENDER ================= */
function renderFloatingBar(){
  const bar = document.getElementById("floatingBar");
  if (!bar) return;

  // üîí ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ viewer mode
  if (state.mode !== "viewer" || state.cart.length === 0){
    bar.classList.remove("show");
    bar.innerHTML = "";
    return;
  }

  const wasVisible = bar.classList.contains("show"); // üî¥ FIX: declare before use
  
  const total = state.cart.reduce(
    (s,i)=> s + Number(i.price) * Number(i.qty),
    0
  );

  bar.innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;font-weight:600">
      üõí ${state.cart.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    </div>
    <div id="floatingTotal"
         style="font-weight:700;color:#007aff">
      ‡∏£‡∏ß‡∏° ‡∏ø${total.toLocaleString()}
    </div>
  `;

  // üîí ‡πÑ‡∏°‡πà‡∏¢‡∏∏‡πà‡∏á overlay system
  bar.onclick = openCart;

  bar.classList.remove("scroll-hide"); // üî¥ FIX
  bar.classList.add("show");

  /* ===== First Appear Bounce ===== */
  if (!wasVisible){
    bar.classList.remove("bounce-in");
    bar.classList.add("bounce-in");
    setTimeout(()=>{
      bar.classList.remove("bounce-in");
    },650);
  }

  /* ===== Total Change Animation ===== */
 const totalEl = document.getElementById("floatingTotal");
 if (totalEl){
   const prev = bar.dataset.prevTotal;
   if (prev !== String(total)) {
     bar.dataset.prevTotal = String(total);
     totalEl.classList.remove("total-animate");
     void totalEl.offsetWidth;
     totalEl.classList.add("total-animate");
    }
  }
}  

  
function renderConfirmSheet(){
  const confirmSheet = document.getElementById("confirmSheet");
  if (!confirmSheet) return;
  let total = 0;

  confirmSheet.innerHTML = "<h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>";

  state.cart.forEach(i=>{
    const sum = i.price * i.qty;
    total += sum;

    confirmSheet.innerHTML += `
      <div class="cart-item">
        <div>
          <div class="name">${esc(i.name)}</div>
          <div style="font-size:12px;color:#888">‡∏£‡∏´‡∏±‡∏™: ${i.productId}</div>
          <div style="font-size:13px">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${i.qty}</div>
        </div>
        <div>‡∏ø${sum}</div>
      </div>
    `;
  });

  confirmSheet.innerHTML += `
    <div class="total">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ‡∏ø${total}</div>

    <div class="form-group" style="margin-top:12px">
     <label>‡πÄ‡∏•‡∏Ç PO (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
     <input
       id="poInput"
       placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç PO"
       oninput="state.poNumber = this.value.trim()">
   </div>


<button class="btn btn-primary"
  id="submitBtn"
  ${state.isSubmitting ? "disabled" : ""}
  onclick="submitOrder()">
  ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
</button>
  `;
 
}

/* ================= HEADER RENDER (UPGRADED) ================= */

function renderHeader(){
  const h = document.getElementById("appHeader");
  if(!h) return;

  if(state.mode === "viewer"){
    h.innerHTML = `
      <div style="flex:1">
        <div class="shop-title">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ Luopanich</div>

        <!-- üîç SEARCH ICON + EXPAND -->
<div
   id="viewerSearchWrap"
   class="search-wrap"
   style="
     margin-top:6px;
     max-width:calc(100% - 44px);
   "
 >
          <button
            onclick="toggleViewerSearch()"
            class="search-btn"
          >üîç</button>

          <input
            id="viewerSearchInput"
            placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏£‡∏´‡∏±‡∏™"
            oninput="handleSearch(this.value)"
            onfocus="focusInput(this)"
            class="search-input"
          >
        </div>          
         </div>

 <div style="
   display:flex;
   align-items:center;
   gap:12px;
   margin-left:12px;
 ">

   <div class="filter-wrap">
     <button class="filter-btn"
        onclick="toggleFilterDropdown()">üîΩ</button>

     <div id="filterDropdown" class="filter-dropdown">
       <div class="filter-item" onclick="selectFilter('all')">üì¶ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
       <div class="filter-item" onclick="selectFilter('ready')">‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á</div>
       <div class="filter-item" onclick="selectFilter('shipping')">üöö ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</div>
       <div class="filter-item" onclick="selectFilter('warehouse')">üè¨ ‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢</div>
       <div class="filter-item" onclick="selectFilter('out')">‚ùå ‡∏´‡∏°‡∏î</div>
     </div>
   </div>
      
 <button
   class="menu-btn"
   onclick="openAdminEntry()"
   aria-label="Admin Menu">
   ‚ò∞
 </button>
      </div>
    `;
  }

 if(state.mode === "admin"){
  h.innerHTML = `
    <div class="header-left">
      <div style="flex:1">
        <div class="admin-title" style="margin-left:7px;">
   ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
 </div>
 <div class="admin-motto">
   ‚ù§Ô∏è ‡∏™‡∏π‡πâ ‡πÜ ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å
 </div>
      </div>

      <!-- üîç SEARCH (ICON EXPAND LIKE VIEWER) -->
      <div class="search-wrap" id="adminSearchWrap">
        <button
          class="search-btn"
          onclick="toggleAdminSearch()"
          aria-label="Search">
          üîç
        </button>
        <input
          class="search-input"
          placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏£‡∏´‡∏±‡∏™"
          oninput="handleSearch(this.value)"
        />
      </div>
    </div>

 <button
   class="menu-btn"
   style="margin-left:12px"
   onclick="openAdminMenu()"
   aria-label="Open Admin Menu">
   ‚ò∞
 </button>
  `;
}

} // ‚úÖ ‡∏õ‡∏¥‡∏î renderHeader()
  
/* üîç viewer search toggle (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ UI) */
function toggleViewerSearch(){
  const wrap  = document.getElementById("viewerSearchWrap");
  const input = document.getElementById("viewerSearchInput");
  if(!wrap || !input) return;

  const opened = wrap.classList.contains("active");

  if(opened){
    input.value = "";
    state.search = "";
    state.viewerSearchOpen = false;
    renderProducts();
    wrap.classList.remove("active");
  }else{
    state.viewerSearchOpen = true;
    wrap.classList.add("active");
    setTimeout(()=>input.focus(),80);
  }
}

/* üîç admin search toggle (ICON EXPAND) */

function toggleAdminSearch(){
  const wrap = document.getElementById("adminSearchWrap");
  if (!wrap) return;

  const opening = !wrap.classList.contains("active");

  wrap.classList.toggle("active");

  if (opening) {
    const input = wrap.querySelector("input");
    // üïí ‡∏£‡∏≠ animation ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô focus (iOS trick)
    setTimeout(() => input && input.focus(), 120);
  }
}
  
function handleSearch(keyword){
  state.search = keyword.toLowerCase();
  renderProducts();
}

// ================= VIEWER FILTER =================
function setViewerStatus(status){
  // üîí guard: ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ viewer mode
  if(state.mode !== "viewer") return;

  // üîí guard: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤ undefined
  if(!status) return;

  state.viewerFilter.status = status;

  // üîÑ sync UI pill
  renderHeader();

  // üîÑ re-filter product list
  renderProducts();
}

 function toggleFilterDropdown(){
   const el = document.getElementById("filterDropdown");
   if(!el) return;

 const isOpen = el.classList.contains("show");

 document.querySelectorAll(".filter-dropdown.show")
   .forEach(d => d.classList.remove("show"));

 if(!isOpen){
   el.classList.add("show");

   // üî¥ auto close on outside click
   setTimeout(()=>{
     document.addEventListener("click", closeFilterOnOutside, { once:true });
   }, 0);
 }
}

  function closeFilterOnOutside(e){
   const wrap = document.querySelector(".filter-wrap");
   if(!wrap || wrap.contains(e.target)) return;

   const el = document.getElementById("filterDropdown");
   if(el) el.classList.remove("show");
 }

 function selectFilter(status){
   setViewerStatus(status); // üîí ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ logic ‡πÄ‡∏î‡∏¥‡∏°
   const el = document.getElementById("filterDropdown");
   if(el) el.classList.remove("show");
 }
  
function openAdminEntry(){
  // üîí ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ session ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÄ‡∏Ç‡πâ‡∏≤ admin ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  if (state.admin.loggedIn && state.admin.token) {
    enterAdmin();
    return;
  }

  // üîì ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà login ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ login
  renderAdminLogin();
}


function enterAdmin(){
  state.mode = "admin";
  state.search = ""; // ‚úÖ reset
  state.viewerSearchOpen = false;
  renderHeader();
  renderProducts();
}

function exitAdmin(){
  // üîí ‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å overlay ‡∏ú‡πà‡∏≤‡∏ô Overlay Manager (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
  document
    .querySelectorAll(".sheet.show, .side-menu.show")
    .forEach(el => {
      closeOverlay(el); // ‚úÖ ‡∏´‡∏±‡∏ß‡πÉ‡∏à
    });

  // ‚ùå ‡∏Å‡∏±‡∏ô Orders ‡πÄ‡∏î‡πâ‡∏á‡∏ã‡πâ‡∏≥
  allowOpenOrders = false;

  // üßπ CLEAR PERSIST SESSION  ‚Üê üî¥ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  clearAdminSession();

  // üîÑ reset admin state
  state.mode = "viewer";
  state.admin.loggedIn = false;
  state.admin.user = null;
  state.admin.token = null;
  state.admin.orders = [];
  state.admin.selectedOrder = null;
  state.admin.logs = [];

  // üîç reset search
  state.search = "";

  // üîÑ render viewer ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ö‡∏ö clean
  renderHeader();
  renderProducts();
  renderBadge();
}

function handleBackdropClick(){
  if (state.ui.backdropLocked) {

    console.warn('[Backdrop] force unlock');

   // üî¥ FIX: force reset overlay system (emergency exit)
   state.ui.backdropLocked = false;
   const openEls = document.querySelectorAll(".sheet.show, .side-menu.show");
   openEls.forEach(el => el.classList.remove("show"));
   state.ui.overlayCount = 0;

    safeHideLoading();   // ‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏≤‡∏á error
    showToast("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", "warning", 1200);
    return;
  }

  closeTopSheet();
}

function closeTopSheet(){
  const sheets = [
    // üî¥ ADMIN FLOW (top ‚Üí bottom)
    imageViewerSheet,
    adminMenuSheet,           // side menu
    adminProductActionSheet,
    adminProductEditSheet,
    adminStockActionSheet,
    adminOrderSheet,
    adminDashboardSheet,
    adminStockSheet,

    // üîµ VIEWER FLOW
    confirmSheet,
    cartSheet,
    qtySheet,
    productSheet,
    stockSheet
  ];

  for (const sheet of sheets) {
    if (sheet && sheet.classList.contains("show")) {
      // ‚úÖ ‡πÉ‡∏ä‡πâ Overlay Manager ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      closeOverlay(sheet);
      break;
    }
  }
}
 

function showStockError(message){
  stockSheet.innerHTML = `
    <h3 style="color:#ff3b30">‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</h3>

    <div style="
      font-size:15px;
      color:#333;
      line-height:1.5;
      margin-top:8px
    ">
      ${message}
    </div>

    <button class="btn btn-primary"
      style="width:100%;margin-top:16px"
      onclick="closeStockError()">
      ‡∏ï‡∏Å‡∏•‡∏á
    </button>
  `;

  // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Overlay Manager ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  openOverlay(stockSheet);
}


function closeStockError(){
  closeOverlay(stockSheet);
  openOverlay(confirmSheet);
}
  
function openConfirm(){
  if (state.cart.length === 0) return;

  state.ui.backdropLocked = true; // üîí ‡∏•‡πá‡∏≠‡∏Å backdrop ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á confirm

  // ‡∏õ‡∏¥‡∏î cart ‡∏Å‡πà‡∏≠‡∏ô
  closeOverlay(cartSheet);

  // render ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
  renderConfirmSheet();

  // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
  confirmSheet.innerHTML += `
    <button class="btn btn-secondary"
      style="width:100%;margin-top:8px"
      onclick="cancelConfirm()">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
  `;

  // üî• ‡∏´‡∏±‡∏ß‡πÉ‡∏à: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î sheet ‡∏à‡∏£‡∏¥‡∏á
  openOverlay(confirmSheet);
}

  
function cancelConfirm(){
  state.ui.backdropLocked = false;
  closeOverlay(confirmSheet);
  openOverlay(cartSheet);
}

function closeQty(){
  closeOverlay(qtySheet);
}

function openQtySheet(){
  // üîí GUARD: ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡πâ‡∏≤ stock = 0
  if (!state.selectedProduct || Number(state.selectedProduct.stock) <= 0) {
    showToast("‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å", "error");
    return;
  }

  // üîí ‡∏õ‡∏¥‡∏î product sheet ‡∏ú‡πà‡∏≤‡∏ô overlay manager
  closeOverlay(productSheet);

  qtySheet.innerHTML = `
    <h3>‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</h3>

    <div class="form-group">
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</label>
      <div class="qty-input">
        <input
          type="number"
          min="1"
          max="${state.selectedProduct.stock}"
          value="1"
          oninput="state.qty = Number(this.value) || 1">
      </div>
    </div>

    <div class="qty-action">
      <button
        class="btn btn-primary"
        onclick="confirmAddToCart()">
        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
      </button>
    </div>
  `;

  // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Overlay Manager ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  openOverlay(qtySheet);

  showToast("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "info", 1500);

  setTimeout(() => {
    const input = qtySheet.querySelector("input");
    if (input) {
      input.focus();
      focusInput(input);
    }
  }, 100);
}

  
function confirmAddToCart(){
  const p = state.selectedProduct;
  if (!p) return;

  const qty = Number(state.qty) || 1;

  // üîí GUARD: ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô stock
  const existing = state.cart.find(i => i.productId === p.productId);
  const currentQty = existing ? existing.qty : 0;

  if (currentQty + qty > Number(p.stock)) {
    // ‚ùå ‡πÄ‡∏î‡∏¥‡∏°: alert
    // alert(`‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${p.name}" ‡∏°‡∏µ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${p.stock} ‡∏ä‡∏¥‡πâ‡∏ô`);

    // ‚úÖ ‡πÉ‡∏´‡∏°‡πà: toast warning
    showToast(
      `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${p.name}" ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${p.stock} ‡∏ä‡∏¥‡πâ‡∏ô`,
      "warning"
    );
    return;
  }

  if(existing){
    existing.qty += qty;
  }else{
    state.cart.push({
      productId: p.productId,
      name: p.name,
      price: p.price,
      qty: qty
    });
  }

  renderBadge();
  saveCart();

  // ‚úÖ Feedback ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ç‡∏≠‡∏á STEP 2Ô∏è‚É£)
  showToast(
    `‡πÄ‡∏û‡∏¥‡πà‡∏° "${p.name}" ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`,
    "success"
  );

  resetToHome();
}
  
function resetToHome(){
  hardResetUI();
}

function hardResetUI({ refresh = false } = {}){
  // üîí ‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å overlay ‡∏ú‡πà‡∏≤‡∏ô Overlay Manager ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  document.querySelectorAll(".sheet.show, .side-menu.show")
    .forEach(el => {
      closeOverlay(el);
    });

// üîì reset backdrop lock
state.ui.backdropLocked = false;

  // üîÑ reset state
  state.selectedProduct = null;
  state.qty = 1;

  // üîÑ optional refresh
  if (refresh) {
    renderProducts();
  }
}


function renderAdminLogin(){
  adminLoginSheet.innerHTML = `
    <h3>Admin Login</h3>

    <div class="form-group">
      <input id="adminUser"
        placeholder="Username"
        onfocus="focusInput(this)">
    </div>

    <div class="form-group">
      <input id="adminPass"
        type="password"
        placeholder="Password"
        onfocus="focusInput(this)">
    </div>

    <button class="btn btn-primary"
      id="adminLoginBtn"
      style="width:100%;margin-top:12px"
      onclick="handleAdminLogin(this)">
      Login
    </button>

    <button class="btn btn-outline"
      id="adminCancelBtn"
      style="width:100%;margin-top:8px"
      onclick="cancelAdminLogin()">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
  `;

  // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏Å‡∏î backdrop ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ
  state.ui.backdropLocked = false;

  openOverlay(adminLoginSheet);
}

// üîí RATE LIMIT STUB (‡∏Å‡∏±‡∏ô ReferenceError)
function isLoginRateLimited() {
  return false;
}
  

async function handleAdminLogin(btn){
  // üîí ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥
  if (state.isSubmitting) return;

  // üîí force global rate limit (scope-safe)
  if (typeof window.isLoginRateLimited === "function") {
    if (window.isLoginRateLimited()) {
      alert("‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡πà‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà");
      return;
    }
  }

  const userInput = document.getElementById("adminUser");
  const passInput = document.getElementById("adminPass");
  const cancelBtn = document.getElementById("adminCancelBtn");

  const username = userInput.value.trim();
  const password = passInput.value;

  if (!username || !password) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Username ‡πÅ‡∏•‡∏∞ Password");
    return;
  }

  // ================= UX START =================
  state.isSubmitting = true;

  if (btn) {
    btn.disabled = true;
    btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...";
  }
  if (cancelBtn) cancelBtn.disabled = true;

  showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô...");
  // ================= UX END ===================

  try {
    // üîê CALL BACKEND LOGIN
    const form = new URLSearchParams();
    form.append("action", "adminLogin");
    form.append("username", username);
    form.append("password", password);

    const res = await fetch(API_URL, {
      method: "POST",
      body: form
    });

    const json = await res.json();

    if (!json.success || !json.token) {
      throw new Error(json.error || json.message || "Login failed");
    }

    // ‚úÖ SAVE SESSION (STATE)
    state.admin.loggedIn = true;
    state.admin.user = json.username;
    state.admin.token = json.token;
    state.admin.expiredAt = json.expiredAt;

    // ‚úÖ SAVE SESSION (PERSIST)
    saveAdminSession(json);

    // üßπ CLOSE LOGIN SHEET
    closeOverlay(adminLoginSheet);

    // üîì reset lock ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á
    state.ui.backdropLocked = false;

    // üöÄ ENTER ADMIN MODE
    enterAdmin();

  } catch (err) {
    console.error(err);
    alert(err.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ");

  } finally {
    // ================= CLEANUP =================
    safeHideLoading();
    state.isSubmitting = false;

    if (btn) {
      btn.disabled = false;
      btn.textContent = "Login";
    }
    if (cancelBtn) cancelBtn.disabled = false;
  }
}

async function openAdminDashboard(mode = "PENDING", force = false) {
  // ‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ intent ‡∏à‡∏£‡∏¥‡∏á
  if (!force && !allowOpenOrders) return;

  // üîê session guard (‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î UI)
  if (
    !state.admin.loggedIn ||
    !state.admin.token ||
    isAdminSessionExpired()
  ) {
    alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà");
    exitAdmin();
    return;
  }

  // üîí ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏Å‡∏±‡∏ô‡πÄ‡∏î‡πâ‡∏á‡∏ã‡πâ‡∏≥)
  allowOpenOrders = false;

  // ‚úÖ ‡∏õ‡∏¥‡∏î Stock Timeline
  closeOverlay(adminStockSheet);

  // üîç reset search
  state.search = "";

  // ‚úÖ Loading UI
  adminDashboardSheet.innerHTML = `
    <h3>${mode === "PENDING"
      ? "Orders (‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)"
      : "Order History"}</h3>

    <div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
  `;

  openOverlay(adminDashboardSheet);

  try {
    state.admin.orders = await fetchOrders();

    const orders = state.admin.orders.filter(o =>
      mode === "PENDING"
        ? o.status === "PENDING"
        : o.status !== "PENDING"
    );

    adminDashboardSheet.innerHTML = `
      <h3>${mode === "PENDING"
        ? "Orders (‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)"
        : "Order History"}</h3>

      ${
        orders.length
          ? orders.map(o => `
              <div class="card"
                onclick="openAdminOrder('${o.orderId}')">
                <div class="name">${o.orderId}</div>
                <div>Status: ${o.status}</div>
                <div>Total: ‡∏ø${Number(o.total).toLocaleString()}</div>
              </div>
            `).join("")
          : `
            <div style="color:#888;text-align:center;margin-top:24px">
              ${mode === "PENDING"
                ? "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£"
                : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå"}
            </div>
          `
      }
    `;
  } catch (err) {
    console.error(err);

    // üî¥ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô session error ‚Üí ‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (
      err.message?.includes("Session") ||
      err.message?.includes("token")
    ) {
      alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà");
      exitAdmin();
      return;
    }

    adminDashboardSheet.innerHTML = `
      <h3>Orders</h3>

      <div style="text-align:center;color:#d93025;margin-top:32px">
        ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ
      </div>

      <button class="btn btn-secondary"
        style="width:100%;margin-top:16px"
        onclick="handleOpenOrders()">
        üîÑ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
      </button>

      <button class="btn"
        style="width:100%;margin-top:8px"
        onclick="finishAdminAction({ refresh:false })">
        ‚Üê ‡∏Å‡∏•‡∏±‡∏ö
      </button>
    `;
  }
}


function handleOpenOrders() {
  allowOpenOrders = true;
  openAdminDashboard("PENDING", true);
}

async function openStockTimeline() {
  closeOverlay(adminDashboardSheet);

  adminStockSheet.innerHTML = `
    <h3>üì¶ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏ï‡πä‡∏≠‡∏Å</h3>
    <div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
  `;

  openOverlay(adminStockSheet);

  try {
    const logsRes = await fetchStockLogs();
    const logs = Array.isArray(logsRes?.data) ? logsRes.data : [];

    /* ================= GROUP ORDER OUT ================= */
    const orderMap = {};
    const singles = [];

    logs.forEach(l => {
  const time = l.timestamp ? new Date(l.timestamp) : new Date();

  // ‚úÖ ‡πÉ‡∏ä‡πâ orderId ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å sheet (fallback ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤)
  const orderRef = l.orderId || l.ref || null;

  if (l.type === "OUT" && orderRef) {
    if (!orderMap[orderRef]) {
      orderMap[orderRef] = {
        orderId: orderRef,
        time,
        by: l.by || "-",
        items: []
      };
    }

    orderMap[orderRef].items.push({
      productId: l.productId,
      qty: Math.abs(Number(l.qty || 0)),
      before: l.before,
      after: l.after
    });
  } else {
    singles.push({
      ...l,
      _time: time
    });
  }
});

    /* ================= BUILD TIMELINE ================= */
    const timeline = [];

    Object.values(orderMap).forEach(o => {
      timeline.push({
        kind: "ORDER",
        type: "OUT",
        orderId: o.orderId,
        time: o.time,
        by: o.by,
        items: o.items
      });
    });

    singles.forEach(l => {
      timeline.push({
        kind: "STOCK",
        type: l.type,
        productId: l.productId,
        qty: l.qty,
        before: l.before,
        after: l.after,
        time: l._time,
        by: l.by || "-"
      });
    });

    // üïí latest first (safe)
    timeline.sort((a, b) => b.time.getTime() - a.time.getTime());

    /* ================= RENDER ================= */
    adminStockSheet.innerHTML = `
      <h3>üì¶ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏ï‡πä‡∏≠‡∏Å</h3>

      <button class="btn btn-secondary"
        style="width:100%;margin-bottom:12px"
        onclick="finishAdminAction({ refresh:false })">
        ‚Üê ‡∏Å‡∏•‡∏±‡∏ö
      </button>

      ${
        timeline.length
          ? timeline.map(t => {

              if (t.kind === "ORDER") {
                return `
                  <div class="card">
                    <div class="timeline-tag tag-out">
                      üßæ ‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å (‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ${t.orderId})
                    </div>

                    ${t.items.map(i => `
                      <div style="font-size:14px;line-height:1.5">
                        ${i.productId} x ${i.qty}
                        ${
                          Number.isFinite(i.before)
                            ? `<span style="color:#888">
                                (${i.before} ‚Üí ${i.after})
                              </span>`
                            : ""
                        }
                      </div>
                    `).join("")}

                    <div style="font-size:12px;color:#888;margin-top:6px">
                      ${t.time.toLocaleDateString("th-TH")}
                      ${t.time.toLocaleTimeString("th-TH")}
                      ¬∑ ‡πÇ‡∏î‡∏¢ ${t.by}
                    </div>
                  </div>
                `;
              }

              const typeMap = {
                IN:     { text: "‚ûï ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤", class: "tag-in" },
                CREATE: { text: "üÜï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà", class: "tag-create" },
                ADJUST: { text: "‚úèÔ∏è ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å", class: "tag-adjust" }
              };

              const cfg = typeMap[t.type] || { text: t.type, class: "" };

              return `
                <div class="card">
                  <div class="timeline-tag ${cfg.class}">
                    ${cfg.text}
                  </div>

                  <div style="font-size:14px">
                    ${t.productId}
                    ${
                      Number.isFinite(t.before)
                        ? ` (${t.before} ‚Üí ${t.after})`
                        : ""
                    }
                  </div>

                  <div style="font-size:12px;color:#888;margin-top:6px">
                    ${t.time.toLocaleDateString("th-TH")}
                    ${t.time.toLocaleTimeString("th-TH")}
                    ¬∑ ‡πÇ‡∏î‡∏¢ ${t.by}
                  </div>
                </div>
              `;
            }).join("")
          : `
            <div style="text-align:center;color:#888;margin-top:32px">
              ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ï‡πä‡∏≠‡∏Å
            </div>
          `
      }
    `;

  } catch (err) {
    console.error(err);

    adminStockSheet.innerHTML = `
      <h3>üì¶ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏ï‡πä‡∏≠‡∏Å</h3>
      <div style="text-align:center;color:#d93025;margin-top:32px">
        ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ
      </div>
    `;
  }
}



function openAdminOrder(orderId){
  const order = state.admin.orders.find(o => o.orderId === orderId);
  if (!order) return;

  state.admin.selectedOrder = order;

  // ‚úÖ FIX: items ‡πÄ‡∏õ‡πá‡∏ô array ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á parse
  const items = Array.isArray(order.items)
    ? order.items
    : [];

  adminOrderSheet.innerHTML = `
    <h3>${order.orderId}</h3>

    ${items.map(i => `
      <div class="cart-item">
        <div>${i.name} x ${i.qty}</div>
        <div>‡∏ø${i.price * i.qty}</div>
      </div>
    `).join("")}

    <div class="total">Total: ‡∏ø${order.total}</div>

    <div class="admin-action">
      <button class="btn btn-approve" onclick="handleApprove()">
        Approve
      </button>

      <button class="btn btn-reject" onclick="handleReject()">
        Reject
      </button>
    </div>
  `;

  // ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ classList
  closeOverlay(adminDashboardSheet);

  // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Overlay Manager
  openOverlay(adminOrderSheet);
}

async function handleApprove() {
  // üîí GUARD: ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô admin mode ‡πÅ‡∏•‡∏∞‡∏°‡∏µ order
  if (state.mode !== "admin" || !state.admin.selectedOrder) return;

  try {
    const o = state.admin.selectedOrder;

    // ‚úÖ CORE: ‡πÉ‡∏ä‡πâ API ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏°‡∏µ loading + toast + guard)
    await adminApproveOrder(o.orderId);

    // ‚úÖ ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Order Detail ‡∏ú‡πà‡∏≤‡∏ô Overlay Manager
    closeOverlay(adminOrderSheet);

    // üîÑ refresh stock + product list
    await refreshProducts();

    // ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î Orders (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ flow ‡∏ô‡∏µ‡πâ)
    allowOpenOrders = true;

    // ‚úÖ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Orders (‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)
    await openAdminDashboard("PENDING", true);

  } catch (err) {
    // ‚ùå ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á alert ‡∏ã‡πâ‡∏≥
    // toast + error handling ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ô adminApproveOrder ‡πÅ‡∏•‡πâ‡∏ß
    console.warn("handleApprove aborted:", err);
  }
}

async function handleReject() {
  // üîí GUARD: ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô admin mode ‡πÅ‡∏•‡∏∞‡∏°‡∏µ order
  if (state.mode !== "admin" || !state.admin.selectedOrder) return;

  try {
    const o = state.admin.selectedOrder;

    // ‚úÖ CORE: ‡πÉ‡∏ä‡πâ API ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏°‡∏µ loading + toast + guard)
    await adminRejectOrder(o.orderId);

    // ‚úÖ ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Order Detail ‡∏ú‡πà‡∏≤‡∏ô Overlay Manager
    closeOverlay(adminOrderSheet);

    // üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÅ‡∏°‡πâ reject ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î stock ‡πÅ‡∏ï‡πà UI ‡∏ï‡πâ‡∏≠‡∏á sync)
    await refreshProducts();

    // ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î Orders (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ flow ‡∏ô‡∏µ‡πâ)
    allowOpenOrders = true;

    // ‚úÖ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Orders (‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)
    await openAdminDashboard("PENDING", true);

  } catch (err) {
    // ‚ùå ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á alert ‡∏ã‡πâ‡∏≥
    // toast + error handling ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ô adminRejectOrder ‡πÅ‡∏•‡πâ‡∏ß
    console.warn("handleReject aborted:", err);
  }
}

async function submitStockIn(){
  // üîí guard
  if (state.mode !== "admin" || !state.selectedProduct) {
    alert("Unauthorized");
    return;
  }

  const qtyInput    = document.getElementById("stockQty");
  const reasonInput = document.getElementById("stockReason");

  const qty    = Number(qtyInput.value);
  const reason = reasonInput.value.trim();

  // üîç validate
  if (!Number.isInteger(qty) || qty <= 0) {
    alert("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    qtyInput.focus();
    return;
  }

  // üîí disable ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥
  const buttons = adminStockActionSheet.querySelectorAll("button");
  buttons.forEach(b => b.disabled = true);

  try {
    const res = await adminStockIn(
      state.selectedProduct.productId,
      qty,
      reason
    );

    if (res.error) {
      throw new Error(res.error);
    }

    alert("‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß");

    // üîÑ refresh ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    await refreshProducts();

    // üßπ reset input
    qtyInput.value = "";
    reasonInput.value = "";

    // ‚úÖ ‡∏õ‡∏¥‡∏î Stock Action ‡∏ú‡πà‡∏≤‡∏ô Overlay Manager
    closeOverlay(adminStockActionSheet);

    // ‚úÖ ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏°‡πà‡∏Ç‡∏≠‡∏á admin ‡πÅ‡∏ö‡∏ö‡∏ô‡∏¥‡πà‡∏á
    finishAdminAction({ refresh: true });

  } catch (err) {
    console.error(err);
    alert(err.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏î‡πâ");
  } finally {
    // üîì ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ
    buttons.forEach(b => b.disabled = false);
  }
}


async function submitStockAdjust(){
  // üîí guard
  if (state.mode !== "admin" || !state.selectedProduct) {
    alert("Unauthorized");
    return;
  }

  const qtyInput    = document.getElementById("stockQty");
  const reasonInput = document.getElementById("stockReason");

  const newQty = Number(qtyInput.value);
  const reason = reasonInput.value.trim();

  // üîç validate
  if (!Number.isInteger(newQty) || newQty < 0) {
    alert("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    qtyInput.focus();
    return;
  }

  // üîí disable ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥
  const buttons = adminStockActionSheet.querySelectorAll("button");
  buttons.forEach(b => b.disabled = true);

  try {
    const res = await adminStockAdjust(
      state.selectedProduct.productId,
      newQty,
      reason
    );

    if (res.error) {
      throw new Error(res.error);
    }

    alert("‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß");

    // üîÑ refresh ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    await refreshProducts();

    // üßπ reset input
    qtyInput.value = "";
    reasonInput.value = "";

    // ‚úÖ ‡∏õ‡∏¥‡∏î Stock Action ‡∏ú‡πà‡∏≤‡∏ô Overlay Manager
    closeOverlay(adminStockActionSheet);

    // ‚úÖ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (flow ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
    openAdminProductAction(state.selectedProduct);

  } catch (err) {
    console.error(err);
    alert(err.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏î‡πâ");
  } finally {
    // üîì ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ
    buttons.forEach(b => b.disabled = false);
  }
}
  
function openStockAction(p){
  // üîí guard
  if (state.mode !== "admin") return;

  state.selectedProduct = p;

  adminStockActionSheet.innerHTML = `
    <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πä‡∏≠‡∏Å</h3>
    <div>${p.name}</div>
    <div>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${p.stock}</div>

    <div class="form-group">
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
      <div class="qty-input">
        <input
          id="stockQty"
          type="number"
          min="0"
          placeholder="‡πÄ‡∏ä‡πà‡∏ô 10"
        >
      </div>
    </div>

    <div class="form-group">
      <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
      <input
        id="stockReason"
        placeholder="‡∏ñ‡πâ‡∏≤‡∏°‡∏µ"
      >
    </div>

    <button
      class="btn btn-secondary"
      onclick="submitStockIn()">
      ‚ûï ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ (IN)
    </button>

    <button
      class="btn btn-primary"
      style="margin-top:8px"
      onclick="submitStockAdjust()">
      ‚úèÔ∏è ‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î
    </button>
  `;

  // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Overlay Manager ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  openOverlay(adminStockActionSheet);
}

async function refreshProductsWithFeedback({
  loadingText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...",
  successText = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
  silent = false
} = {}) {
  try {
    // 1Ô∏è‚É£ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô (UX ‡∏•‡∏∑‡πà‡∏ô)
    if (Array.isArray(state.products) && state.products.length) {
      renderProducts();
    }

    // 2Ô∏è‚É£ ‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ)
    if (!silent) {
      showToast(loadingText, "info", 1200);
    }

    // 3Ô∏è‚É£ ‡πÉ‡∏ä‡πâ CORE function (single source of truth)
    await refreshProducts();

    // 4Ô∏è‚É£ ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    if (!silent) {
      showToast(successText, "success", 1000);
    }

  } catch (err) {
    console.error(err);

    // 5Ô∏è‚É£ ‡πÅ‡∏à‡πâ‡∏á error ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏±‡∏á UI
    if (!silent) {
      showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ", "error");
    }
  }
}
 
function openAdminMenu(){
  if (
    !state.admin.loggedIn ||
    !state.admin.token ||
    isAdminSessionExpired()
  ) {
    alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà");
    exitAdmin();
    return;
  }
  
  adminMenuSheet.innerHTML = `
    <h3>Admin Menu</h3>

    <!-- üîπ MAIN ACTIONS -->
    <div class="menu-group">
      <button class="btn btn-primary"
        onclick="closeAdminMenu(); handleOpenOrders();">
        üì¶ Orders
      </button>

      <button class="btn btn-secondary"
        onclick="closeAdminMenu(); openStockTimeline();">
        üì¶ Stock Timeline
      </button>

      <button class="btn btn-secondary"
        onclick="closeAdminMenu(); openAddProduct();">
        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
      </button>
    </div>

    <hr>

    <!-- üîª DANGER ZONE -->
    <div class="menu-group danger">
      <button class="btn btn-danger"
        onclick="exitAdmin();">
        üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
      </button>
    </div>
  `;

  // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Overlay Manager ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  openOverlay(adminMenuSheet);
}

function openAddProduct(){
  state.addImageFile = null;
  const draft = state.smartAddDraft || {};

  adminAddProductSheet.innerHTML = `
    <h3>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>

    <div style="font-size:13px;color:#666;margin-bottom:12px">
      ‚ÑπÔ∏è ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Stock Timeline
    </div>

    <div class="form-group">
      <label>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU)</label>
      <input id="addProductId" placeholder="‡πÄ‡∏ä‡πà‡∏ô P002">
    </div>

    <div class="form-group">
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
      <input id="addName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
    </div>

    <div class="form-group">
      <label>‡∏£‡∏≤‡∏Ñ‡∏≤</label>
      <input id="addPrice" type="number" value="${draft.price || ""}" placeholder="0">
    </div>

    <div class="form-group">
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)</label>
      <input id="addStock" type="number" value="${draft.stock || ""}" placeholder="0">
    </div>

    <!-- üî¥ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤) -->
    <div class="form-group">
      <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
      <select id="addStatus">
        <option value="ready" ${draft.status==="ready"?"selected":""}>‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á</option>
        <option value="shipping" ${draft.status==="shipping"?"selected":""}>‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</option>
        <option value="warehouse" ${draft.status==="warehouse"?"selected":""}>‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢</option>
        <option value="out" ${draft.status==="out"?"selected":""}>‡∏´‡∏°‡∏î</option>
      </select>
    </div>

<!-- üìù NEW: NOTE FIELD -->
<div class="form-group">
  <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
  <textarea
    id="addNote"
    rows="3"
    placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏° / ‡∏ï‡∏≥‡∏´‡∏ô‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ñ‡∏∂‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"
    style="
      resize:none;
      font-size:14px;
      line-height:1.4;
      border-radius:12px;
      padding:10px 12px;
    "
  >${draft.note || ""}</textarea>
</div>

    <div class="form-group">
      <label>‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
      <img id="addImagePreview"
        style="width:120px;border-radius:12px;display:none;margin-bottom:6px">
      <input type="file"
        accept="image/*"
        onchange="handleAddImagePreview(this)">
    </div>

    <!-- üîÅ CONTINUE MODE -->
    <div class="form-group">
      <label style="display:flex;align-items:center;gap:8px;">
        <input type="checkbox" id="addContinueMode">
        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°)
      </label>
    </div>

    <button class="btn btn-primary"
      style="width:100%;margin-top:16px"
      onclick="submitAddProduct(this)">
      ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    </button>

    <button class="btn btn-secondary"
      style="width:100%;margin-top:8px"
      onclick="closeAddProduct()">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
  `;

  openOverlay(adminAddProductSheet);
}


function handleAddImagePreview(input){
  const file = input.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    const img = document.getElementById("addImagePreview");
    img.src = reader.result;
    img.style.display = "block";

    state.addImageFile = file; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ upload
  };
  reader.readAsDataURL(file);
}

function closeAddProduct(){
  state.addImageFile = null;
  closeOverlay(adminAddProductSheet);
}
  
function closeAdminMenu(){
  closeOverlay(adminMenuSheet);
}
   
/* ================= VIEWER FLOW ================= */
function openProduct(p){
  // üî¥ ADMIN FLOW
  // ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‚Üí ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î product sheet ‡πÅ‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
  if (state.mode === "admin") {
    openAdminProductAction(p);
    return;
  }

  // üü¢ VIEWER FLOW
  state.selectedProduct = p;
  state.qty = 1;

  renderProductSheet();

  // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Overlay Manager ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  openOverlay(productSheet);
}

// üî¥ NEW: cancel admin login
function cancelAdminLogin(){
  closeOverlay(adminLoginSheet);
}
  
function closeProduct(){
  closeOverlay(productSheet);
}

async function submitOrder(){
  // ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ state.loading ‡πÄ‡∏õ‡πá‡∏ô guard
  if (state.isSubmitting || state.cart.length === 0) return;

  state.isSubmitting = true;
  state.ui.backdropLocked = true;

  try {
    // ================= STEP 1: CHECK STOCK =================
    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å...');
    const stockCheck = await checkStockBeforeSubmit();

    if (!stockCheck.ok) {
      showToast(stockCheck.message, 'warning');
      throw new Error("STOCK_CHECK_FAILED");
    }

    // ================= STEP 2: CREATE ORDER =================
    updateLoadingText('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠...');
    const res = await createOrder();

    if (!res || res.success !== true || !res.data?.orderId) {
      throw new Error("Invalid order response");
    }

    // ================= SUCCESS =================
    state.lastOrder = {
      orderId: res.data.orderId,
      items: JSON.parse(JSON.stringify(state.cart)),
      total: state.cart.reduce(
        (s,i)=> s + Number(i.price) * Number(i.qty),
        0
      ),
 createdAt: new Date(),
 poNumber: state.poNumber || ""
    };

    showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
    showToast("‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠", "info", 3000);

 // ‡πÄ‡∏õ‡∏¥‡∏î confirmSheet ‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
 confirmSheet.innerHTML = `
   <h3>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
   <div style="margin-top:12px">
     ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: ${res.data.orderId}
   </div>
   <button class="btn btn-primary"
     style="margin-top:16px"
     onclick="exportOrderPrint()">
     ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
   </button>
 `;

// confirmSheet ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á reopen

    state.cart = [];
    clearCartStorage();
    state.poNumber = "";
    renderBadge();
    
  // ‚ùå ‡∏´‡πâ‡∏≤‡∏° auto reset ‡∏´‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á order ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    
  } catch(err){
    console.error(err);
    showToast(
      err.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠',
      'error'
    );
  } finally {
    safeHideLoading();
    state.isSubmitting = false;
    // üîí ‡∏õ‡∏•‡∏î lock ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ sheet ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà (‡∏Å‡∏±‡∏ô race condition)
    if (state.ui.overlayCount === 0) {
      state.ui.backdropLocked = false;
    }
  }
}


function openCart(){
  renderCart();

  // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Overlay Manager ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  openOverlay(cartSheet);
}

function closeCart(){
  closeOverlay(cartSheet);
}

function removeItem(idx){
  state.cart.splice(idx, 1);

  // ‚úÖ PERSIST: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å cart ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
  saveCart();

  renderBadge();

  // üîî Feedback: ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ß‡πà‡∏≤‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß
  showToast("‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß", "warning");

  if(state.cart.length === 0){
    hardResetUI();   // ‚úÖ ‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å sheet + backdrop
  } else {
    renderCart();
  }
}

function openProductEdit(p){
  state.selectedProduct = p;
  state.compareImagesDraft = (p.compareImages || "")
    .split(",")
    .map(s => s.trim())
    .filter(Boolean);

  adminProductEditSheet.innerHTML = `
    <h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>

    <div class="form-group">
      <label>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU)</label>
      <input id="editProductId" value="${p.productId}">
    </div>

    <div class="form-group">
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
      <input id="editName" value="${p.name}">
    </div>

    <div class="form-group">
      <label>‡∏£‡∏≤‡∏Ñ‡∏≤</label>
      <input id="editPrice" type="number" value="${p.price}">
    </div>

    <div class="form-group">
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
      <input id="editStock" type="number" value="${p.stock}">
    </div>

    <div class="form-group">
      <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
      <select id="editStatus">
        <option value="ready" ${p.status === "ready" ? "selected" : ""}>
          ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á
        </option>
        <option value="shipping" ${p.status === "shipping" ? "selected" : ""}>
          ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
        </option>
        <option value="warehouse" ${p.status === "warehouse" ? "selected" : ""}>
          ‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢
        </option>
        <option value="out" ${p.status === "out" ? "selected" : ""}>
          ‡∏´‡∏°‡∏î
        </option>
      </select>
    </div>

    <!-- üìù NEW: NOTE FIELD -->
    <div class="form-group">
      <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)</label>
      <textarea
        id="editNote"
        rows="3"
        placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏≥‡∏´‡∏ô‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ / ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏° / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏†‡∏≤‡∏¢‡πÉ‡∏ô"
        style="
          resize: none;
          font-size: 14px;
          line-height: 1.4;
          border-radius: 12px;
          padding: 10px 12px;
        "
      >${p.note || ""}</textarea>
    </div>

    <!-- üìÑ PRODUCT DETAIL (VIEWER) -->
    <div class="form-group">
      <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</label>
      <textarea
        id="editDetailsText"
        rows="4"
        placeholder="‡πÉ‡∏™‡πà‡∏ó‡∏µ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î"
      >${p.detailsText || ""}</textarea>
    </div>

<div class="form-group">
  <label>‡∏£‡∏π‡∏õ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>

  <!-- preview -->
  <div id="comparePreview"
       style="display:flex;gap:8px;overflow-x:auto;margin-bottom:8px">
  ${
    state.compareImagesDraft.map((url, idx) => `
      <div style="position:relative">
        <img src="${url}"
             style="
               width:80px;
               height:80px;
               object-fit:cover;
               border-radius:10px;
               box-shadow: var(--shadow-image)
             ">
        <button
          onclick="removeCompareImage(${idx})"
          style="
            position:absolute;
            top:-6px;
            right:-6px;
            width:20px;
            height:20px;
            border:none;
            border-radius:50%;
            background:#ff3b30;
            color:#fff;
            font-size:12px;
            cursor:pointer;
          "
        >√ó</button>
      </div>
    `).join("")
  }
  </div>

  <!-- upload -->
  <input
    type="file"
    multiple
    accept="image/*"
    onchange="handleCompareImagesUpload(this)">
</div>

    <!-- ‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
    <div class="form-group">
      <label>‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
      <img id="imagePreview"
        src="${p.image || ""}"
        style="width:100%;border-radius:12px;margin-bottom:6px">
      <input type="file"
        accept="image/*"
        onchange="handleImagePreview(this)">
    </div>

    <button class="btn btn-primary"
      style="width:100%;margin-top:16px"
      onclick="submitProductEdit()">
      ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    </button>

    <button class="btn btn-secondary"
      style="width:100%;margin-top:8px"
      onclick="closeProductEdit()">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>

    <!-- üî¥ SOFT DELETE PRODUCT -->

 ${p.active === false ? `
   <div style="
     margin-top:16px;
     font-size:13px;
     color:#888;
     text-align:center
   ">
     ‚õî ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß
   </div>
 ` : `
   <button class="btn btn-danger"
     style="width:100%;margin-top:16px"
     onclick="confirmDeleteProduct()">
     üóëÔ∏è ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
   </button>
 `}
  `;

  openOverlay(adminProductEditSheet); // ‚úÖ ‡πÉ‡∏ä‡πâ Overlay Manager
}

function removeCompareImage(index){
  if (!Array.isArray(state.compareImagesDraft)) return;

  state.compareImagesDraft.splice(index, 1);

  // re-render preview ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  const wrap = document.getElementById("comparePreview");
  if (!wrap) return;

  wrap.innerHTML = state.compareImagesDraft.map((url, idx) => `
    <div style="position:relative">
      <img src="${url}"
           style="
             width:80px;
             height:80px;
             object-fit:cover;
             border-radius:10px;
             box-shadow: var(--shadow-image)
           ">
      <button
        onclick="removeCompareImage(${idx})"
        style="
          position:absolute;
          top:-6px;
          right:-6px;
          width:20px;
          height:20px;
          border:none;
          border-radius:50%;
          background:#ff3b30;
          color:#fff;
          font-size:12px;
          cursor:pointer;
        "
      >√ó</button>
    </div>
  `).join("");
}

function handleImagePreview(input){
  const file = input.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    document.getElementById("imagePreview").src = reader.result;

    // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏ß‡πâ‡∏£‡∏≠ STEP 7.5.2
    state.editImageFile = file;
  };
  reader.readAsDataURL(file);
}

async function handleCompareImagesUpload(input){
  const files = Array.from(input.files || []);
  if (!files.length) return;

  // üîí guard
  if (!state.admin?.token) {
    showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà", "warning");
    return;
  }

  showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...");

  try {
    const urls = [];

    for (const file of files) {
      const url = await uploadProductImage(file);
      if (url) urls.push(url);
    }

   // ‚úÖ STEP 8: merge ‡πÄ‡∏Ç‡πâ‡∏≤ state ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
   state.compareImagesDraft.push(...urls);

   // üîÑ re-render preview ‡∏ú‡πà‡∏≤‡∏ô state (‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏° ‚ùå)
   const wrap = document.getElementById("comparePreview");
   if (wrap) {
     wrap.innerHTML = state.compareImagesDraft.map((url, idx) => `
       <div style="position:relative">
         <img src="${url}"
              style="
                width:80px;
                height:80px;
                object-fit:cover;
                border-radius:10px;
                box-shadow: var(--shadow-image)
              ">
         <button
           onclick="removeCompareImage(${idx})"
           style="
             position:absolute;
             top:-6px;
             right:-6px;
             width:20px;
             height:20px;
             border:none;
             border-radius:50%;
             background:#ff3b30;
             color:#fff;
             font-size:12px;
             cursor:pointer;
           "
         >√ó</button>
       </div>
     `).join("");
   }
  
    showToast("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");

  } catch (err) {
    console.error(err);
    showToast("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error");
  } finally {
    safeHideLoading();
    input.value = "";
  }
}
  
function closeProductEdit(){
  state.editImageFile = null;
  closeOverlay(adminProductEditSheet);
}

async function uploadProductImage(file) {
  return new Promise((resolve, reject) => {
    // üîí guard token
    if (!state.admin || !state.admin.token) {
      reject("Missing admin token");
      return;
    }

    const reader = new FileReader();

    reader.onload = async () => {
      try {
        // üîπ ‡∏ï‡∏±‡∏î data:image/...;base64,
        const base64 = reader.result.split(",")[1];

        // ‚úÖ ‡πÉ‡∏ä‡πâ FormData
        const formData = new FormData();
        formData.append("action", "uploadProductImage"); // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏≠‡∏¢‡∏π‡πà)
        formData.append("token", state.admin.token);
        formData.append("filename", file.name);
        formData.append("mimeType", file.type || "image/jpeg");
        formData.append("data", base64);

        const res = await fetch(API_URL, {
          method: "POST",
          body: formData
        });

        const json = await res.json();

        // üîí backend wrap data ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô data
        if (!json.success || !json.data || !json.data.imageUrl) {
          reject(json.error || json.message || "Upload failed");
          return;
        }

        // ‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        resolve(json.data.imageUrl);

      } catch (err) {
        reject(err);
      }
    };

    reader.onerror = () => {
      reject("File read error");
    };

    reader.readAsDataURL(file);
  });
}
  
async function submitProductEdit(){
  // üîí GUARD: ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥
  if (state.isSubmitting) return;

  const p = state.selectedProduct;
  if (!p) return;

  state.isSubmitting = true;

  // üîí LOCK BUTTON
  const saveBtn = adminProductEditSheet.querySelector(".btn-primary");
  const originalText = saveBtn?.textContent;
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
  }

  const name   = document.getElementById("editName").value.trim();
  const price  = Number(document.getElementById("editPrice").value);
  const stock  = Number(document.getElementById("editStock").value);
  const status = document.getElementById("editStatus").value;
  const newProductId = document.getElementById("editProductId").value.trim();
  const oldProductId = p.productId;
  const note   = document.getElementById("editNote")?.value.trim() || "";
  const detailsText =
  document.getElementById("editDetailsText")?.value.trim() || "";

 const compareImages =
   Array.isArray(state.compareImagesDraft)
     ? state.compareImagesDraft.join(",")
     : "";

  // üîí Validate
  if (
   !name ||
   !newProductId ||
   !Number.isFinite(price) ||
   !Number.isFinite(stock) ||
   price < 0 ||
   stock < 0
 ) {
    showToast("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "error");

    // üîì ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏†‡∏≤‡∏û‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    state.isSubmitting = false;
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.textContent = originalText;
    }
    return;
  }

  // üîí SKU Duplicate Check (‡∏ß‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
  const duplicate = state.products.find(
    x => x.productId === newProductId && x.productId !== oldProductId
  );
 
  if (duplicate) {
    showToast("‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß", "error");
    state.isSubmitting = false;
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.textContent = originalText;
    }
    return;
  }

  let imageUrl = p.image || "";

  try {
    showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...");

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà ‚Üí upload ‡∏Å‡πà‡∏≠‡∏ô
    if (state.editImageFile) {
      imageUrl = await uploadProductImage(state.editImageFile);
      if (!imageUrl) {
        throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ");
      }
    }

    // Update product
    const form = new URLSearchParams();
    form.append("action", "updateProduct");
    form.append("token", state.admin.token);
    form.append("oldProductId", oldProductId);
    form.append("newProductId", newProductId);
    form.append("name", name);
    form.append("price", price);
    form.append("stock", stock);
    form.append("status", status);
    form.append("image", imageUrl);
    form.append("note", note);
    form.append("detailsText", detailsText);
    form.append("compareImages", compareImages);

    const res = await fetch(API_URL, {
      method: "POST",
      body: form
    }).then(r => r.json());

    if (res.error || res.success === false) {
      throw new Error(res.message || res.error || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }

    showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success");

    state.selectedProduct = null;

    // cleanup
    state.editImageFile = null;
    closeProductEdit();
    await refreshProducts();

  } catch (err) {
    console.error(err);
    showToast(
      err.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤",
      "error"
    );

  } finally {
    // ‚úÖ CLEANUP ‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏´‡∏±‡∏ß‡πÉ‡∏à STEP 9)
    safeHideLoading();
    state.isSubmitting = false;

    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.textContent = originalText;
    }
  }
}

function confirmDeleteProduct() {
  if (state.mode !== "admin") return;
  if (state.admin.isSubmitting || state.isSubmitting) return;
  const p = state.selectedProduct;
  if (!p) return;

  // üîí ‡∏Å‡∏±‡∏ô‡∏•‡∏ö‡∏ã‡πâ‡∏≥
  if (p.active === false) {
    showToast("‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß", "warning");
    return;
  }
  
 const ok = confirm(
   `‚ö†Ô∏è ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£\n\n` +
   `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: "${p.name}"\n` +
   `‡∏£‡∏´‡∏±‡∏™: ${p.productId}\n\n` +
   `‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ\n\n` +
   `‡∏Å‡∏î OK ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô`
 );

  if (!ok) return;

  deleteProduct();
}

async function deleteProduct() {
  if (state.admin.isSubmitting || state.isSubmitting) return;

  const p = state.selectedProduct;
  if (!p || !state.admin.token) return;

  state.admin.isSubmitting = true;
  state.isSubmitting = true;

  try {
    showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...");

    const form = new URLSearchParams();
    form.append("action", "deleteProduct");
    form.append("token", state.admin.token);
    form.append("productId", p.productId);

    const res = await fetch(API_URL, {
      method: "POST",
      body: form
    }).then(r => r.json());

    if (res.error || res.success === false) {
      if (
        res.error === "Session expired" ||
        res.error === "Invalid token" ||
        res.error === "Missing token"
      ) {
        showToast("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà", "warning");
        exitAdmin();
        return;
      }
        throw new Error(
        res.message || res.error || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ (‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß)"
      );
    }
    
    showToast("‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success");

    closeProductEdit();

    // üîí clear selection ‡∏Å‡πà‡∏≠‡∏ô sync
    state.selectedProduct = null;

    // üîÑ refresh ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    await refreshProducts();

  } catch (err) {
    console.error(err);
    showToast(err.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "error");

  } finally {
    safeHideLoading();
    state.admin.isSubmitting = false;
    state.isSubmitting = false;
  }
}
  
  
async function submitAddProduct(btn){
  // üîí guard
  if(state.mode !== "admin" || !state.admin.loggedIn){
    alert("Unauthorized");
    return;
  }

  // üîí ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥
  if(state.isSubmitting) return;
  state.isSubmitting = true;

  // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏≤‡∏Å parameter
  if(btn){
    btn.disabled = true;
    btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...";
  }

  try {
    // üîî UX: ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£
    showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...");
    const productId = document.getElementById("addProductId").value.trim();
    const name      = document.getElementById("addName").value.trim();
    const price     = Number(document.getElementById("addPrice").value);
    const stock     = Number(document.getElementById("addStock").value);
 let status      = document.getElementById("addStatus").value;
 const note      = document.getElementById("addNote")?.value.trim() || "";
 const continueMode =
   document.getElementById("addContinueMode")?.checked === true;   
 const active    = true; // üîí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà = ‡∏¢‡∏±‡∏á‡∏Ç‡∏≤‡∏¢‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏™‡∏°‡∏≠

    /* ================= VALIDATE ================= */

    if (!productId) {
      document.getElementById("addProductId").focus();
      throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU)");
    }

    if (!name) {
      document.getElementById("addName").focus();
      throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
    }

    if (!Number.isInteger(price) || !Number.isInteger(stock)) {
      throw new Error("‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°");
    }

    if (price < 0 || stock < 0) {
      throw new Error("‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 0");
    }

    const dup = state.products.find(p => p.productId === productId);
    if (dup) {
      document.getElementById("addProductId").focus();
      throw new Error("‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU) ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
    }

    /* ================= AUTO STATUS ================= */
    if (stock === 0) {
      status = "out";
    }

    /* ================= IMAGE UPLOAD ================= */

    let imageUrl = "";
    if (state.addImageFile) {
      showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...");
      imageUrl = await uploadProductImage(state.addImageFile);
      if (!imageUrl) {
        throw new Error("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      }
    }

    /* ================= SEND TO BACKEND ================= */
    showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...");
    
    const form = new URLSearchParams();
    form.append("action", "addProduct"); // ‚úÖ FIX ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤
    form.append("token", state.admin.token);
    form.append("productId", productId);
    form.append("name", name);
    form.append("price", price);
    form.append("stock", stock);
  form.append("active", active);
  form.append("status", status);
    form.append("image", imageUrl);
    form.append("note", note);

    const res = await fetch(API_URL, {
      method: "POST",
      body: form
    }).then(r => r.json());

    if(res.error || res.success === false){
      throw new Error(res.message || res.error || "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }

    showToast("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ üéâ", "success");

    state.addImageFile = null;
 // üß† SMART MODE SAVE (‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏™‡∏°‡∏≠)
 state.smartAddDraft = {
   price,
   stock,
   status,
   note
 };
 await refreshProducts();

 if (continueMode) {
   // üîÅ ‡∏¢‡∏¥‡∏á‡∏£‡∏±‡∏ß: ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ SKU + ‡∏£‡∏π‡∏õ
   document.getElementById("addProductId").value = "";
   document.getElementById("addStock").value = state.smartAddDraft.stock ?? "";

   const img = document.getElementById("addImagePreview");
   if (img) {
     img.src = "";
     img.style.display = "none";
   }

   document.getElementById("addProductId").focus();
 } else {
   closeAddProduct();
 }

  } catch(err){
    console.error(err);
    showToast(err.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "error");
  } finally {
    safeHideLoading(); // üîí ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏õ‡∏¥‡∏î loading ‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ
    state.isSubmitting = false;

    if(btn){
      btn.disabled = false;
      btn.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤";
    }
  }
}

function openAdminProductAction(p){
  // üîí guard
  if (state.mode !== "admin") return;

  state.selectedProduct = p;

  adminProductActionSheet.innerHTML = `
    <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>

    <div style="
      font-weight:600;
      font-size:16px;
      margin-bottom:4px
    ">
      ${p.name}
    </div>

    <div style="
      font-size:12px;
      color:#888;
      margin-bottom:16px
    ">
      ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${p.productId}
    </div>

    <!-- ‚úèÔ∏è EDIT PRODUCT -->
    <button class="btn btn-primary"
      style="width:100%;margin-bottom:10px"
      onclick="
        closeAdminProductAction();
        openProductEdit(state.selectedProduct);
      ">
      ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    </button>

    <!-- üì¶ STOCK -->
    <button class="btn btn-secondary"
      style="width:100%;margin-bottom:16px"
      onclick="
        closeAdminProductAction();
        openStockAction(state.selectedProduct);
      ">
      üì¶ ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å
    </button>

    <!-- ‚ùå CANCEL -->
    <button class="btn btn-outline"
      onclick="closeAdminProductAction()">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
  `;

  // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Overlay Manager
  openOverlay(adminProductActionSheet);
}

function closeAdminProductAction(){
  closeOverlay(adminProductActionSheet);
}

function isAdminSessionExpired(expiredAt = state.admin.expiredAt) {
  // ‚ùó ‡πÑ‡∏°‡πà‡∏°‡∏µ expiredAt = session invalid ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  if (!expiredAt) return true;

  return Date.now() > new Date(expiredAt).getTime();
}  

/* ================= EXPORT ORDER PNG (FINAL) ================= */
function exportOrderPNG() {
  const order = state.lastOrder;
  if (!order) return;

  /* ================= A4 CONFIG (FIXED) ================= */
  const cfg = {
    width: 794,          // A4 width @96dpi
    height: 1123,        // üî• A4 height fixed
    padding: 64,
    titleSize: 32,
    textSize: 18,
    lineHeight: 34
  };
  /* ================= CANVAS SIZE ================= */
  const items = Array.isArray(order.items) ? order.items : [];

  const po = order.poNumber
    ? String(order.poNumber)
    : "-";

  const customerName = "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏û‡∏•‡∏±‡∏™ 88 ‡∏à‡∏≥‡∏Å‡∏±‡∏î";
  const customerTaxId = "0195566000907";

  const canvas = document.createElement("canvas");
  canvas.width = cfg.width;
  canvas.height = cfg.height;  // üî• FIXED A4

  const ctx = canvas.getContext("2d");

  /* ================= BACKGROUND ================= */
  ctx.fillStyle = "#f2f2f7";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  /* ================= CARD ================= */
  ctx.fillStyle = "#ffffff";
  ctx.shadowColor = "rgba(0,0,0,0.08)";
  ctx.shadowBlur = 20;
  ctx.shadowOffsetY = 6;

  ctx.beginPath();

  if (typeof ctx.roundRect === "function") {
    ctx.roundRect(8, 8, canvas.width - 16, canvas.height - 16, 18);
  } else {
    const x = 8;
    const y0 = 8;
    const w = canvas.width - 16;
    const h = canvas.height - 16;
    const r = 18;

    ctx.moveTo(x + r, y0);
    ctx.lineTo(x + w - r, y0);
    ctx.quadraticCurveTo(x + w, y0, x + w, y0 + r);
    ctx.lineTo(x + w, y0 + h - r);
    ctx.quadraticCurveTo(x + w, y0 + h, x + w - r, y0 + h);
    ctx.lineTo(x + r, y0 + h);
    ctx.quadraticCurveTo(x, y0 + h, x, y0 + h - r);
    ctx.lineTo(x, y0 + r);
    ctx.quadraticCurveTo(x, y0, x + r, y0);
  }

  ctx.fill();
  ctx.shadowColor = "transparent";

  /* ================= TEXT ================= */
  let y = cfg.padding + cfg.lineHeight;
  ctx.fillStyle = "#000";

  /* ===== TITLE ===== */
  ctx.font = `700 ${cfg.titleSize}px -apple-system, BlinkMacSystemFont, sans-serif`;
  ctx.fillText("‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠", cfg.padding, y);
  y += cfg.lineHeight + 8;

  /* ===== HEADER BASE LINE ===== */
  const headerTopY = y;

  /* ===== COMPANY BLOCK ===== */
ctx.font = `700 ${cfg.textSize + 4}px -apple-system`;
ctx.fillText("‡∏£‡πâ‡∏≤‡∏ô‡∏•‡πâ‡∏≠‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå", cfg.padding, headerTopY);

ctx.fillText(
   "7/13 ‡∏´‡∏°‡∏π‡πà 5",
   cfg.padding,
   headerTopY + cfg.lineHeight
 );
 ctx.fillText(
   "‡∏ï.‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏Ç‡∏° ‡∏≠.‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏Ñ",
   cfg.padding,
   headerTopY + cfg.lineHeight * 2
 );
 ctx.fillText(
   "‡∏à.‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ 18140",
   cfg.padding,
   headerTopY + cfg.lineHeight * 3
 );

/* ===== CUSTOMER BLOCK ===== */
ctx.font = `700 ${cfg.textSize}px -apple-system`;
ctx.fillText("‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:", cfg.padding, headerTopY + cfg.lineHeight * 5);

ctx.font = `${cfg.textSize}px -apple-system`;
ctx.fillText(customerName, cfg.padding, headerTopY + cfg.lineHeight * 6);

 ctx.fillText(
   "99 ‡∏´‡∏°‡∏π‡πà 5 ‡∏ï‡∏≥‡∏ö‡∏•‡∏´‡πâ‡∏ß‡∏¢‡∏ó‡∏£‡∏≤‡∏¢",
   cfg.padding,
   headerTopY + cfg.lineHeight * 7
 );

 ctx.fillText(
   "‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏Ñ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ 18230",
   cfg.padding,
   headerTopY + cfg.lineHeight * 8
 );

ctx.fillText(
   `‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ: ${customerTaxId}`,
   cfg.padding,
   headerTopY + cfg.lineHeight * 9
 );


/* ===== DOCUMENT META ===== */
const rightX = canvas.width - cfg.padding;

  ctx.textAlign = "right";
  ctx.fillText(`‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${order.orderId}`, rightX, headerTopY);
 ctx.fillText(`PO: ${po}`, rightX, headerTopY + cfg.lineHeight);
 const docDate = new Date(order.createdAt);
 ctx.fillText(
   `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${docDate.toLocaleDateString("th-TH")}`,
   rightX,
   headerTopY + cfg.lineHeight * 2
 );

  ctx.textAlign = "left";
y = headerTopY + cfg.lineHeight * 11;


  /* ===== DIVIDER ===== */
  ctx.strokeStyle = "#dddddd";
  ctx.beginPath();
  ctx.moveTo(cfg.padding, y);
  ctx.lineTo(canvas.width - cfg.padding, y);
  ctx.stroke();
  y += cfg.lineHeight;

/* ================= ITEMS (GRID TABLE) ================= */
  const tableTopY = y;
  const rowHeight = 42;

  const col = {
    no: cfg.padding,
    name: cfg.padding + 60,
    qty: canvas.width - cfg.padding - 260,
    price: canvas.width - cfg.padding - 180,
    total: canvas.width - cfg.padding - 90
  };

  ctx.font = `700 ${cfg.textSize}px -apple-system`;

  // HEADER
  ctx.fillText("‡∏•‡∏≥‡∏î‡∏±‡∏ö", col.no, y);
  ctx.fillText("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", col.name, y);
  ctx.fillText("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", col.qty, y);
  ctx.fillText("‡∏£‡∏≤‡∏Ñ‡∏≤", col.price, y);
  ctx.fillText("‡∏£‡∏ß‡∏°", col.total, y);

  y += 16;

  ctx.strokeStyle = "#000";
  ctx.beginPath();
  ctx.moveTo(cfg.padding, y);
  ctx.lineTo(canvas.width - cfg.padding, y);
  ctx.stroke();

  y += rowHeight - 16;

  ctx.font = `${cfg.textSize}px -apple-system`;

  items.forEach((i, index) => {
    const total = Number(i.price) * Number(i.qty);

    ctx.fillText(String(index + 1), col.no, y);

    // truncate name (single line grid)
    let name = `[${i.productId}] ${i.name}`;
    while (ctx.measureText(name).width > (col.qty - col.name - 20)) {
      name = name.slice(0, -1);
    }

    ctx.fillText(name, col.name, y);

    ctx.textAlign = "right";
    ctx.fillText(String(i.qty), col.qty + 40, y);
    ctx.fillText(`‡∏ø${Number(i.price).toLocaleString()}`, col.price + 60, y);
    ctx.fillText(`‡∏ø${total.toLocaleString()}`, col.total + 80, y);
    ctx.textAlign = "left";

    // horizontal line
    ctx.beginPath();
    ctx.moveTo(cfg.padding, y + 16);
    ctx.lineTo(canvas.width - cfg.padding, y + 16);
    ctx.strokeStyle = "#ddd";
    ctx.stroke();

    y += rowHeight;
  });
  
  /* ===== DIVIDER ===== */
  y += 4;
  ctx.strokeStyle = "#dddddd";
  ctx.beginPath();
  ctx.moveTo(cfg.padding, y);
  ctx.lineTo(canvas.width - cfg.padding, y);
  ctx.stroke();
  y += cfg.lineHeight;

  /* ================= TOTAL ================= */
  ctx.font = `700 ${cfg.textSize + 4}px -apple-system, BlinkMacSystemFont, sans-serif`;
  const safeTotal = Number(order.total) || 0;
  const totalText = `‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ‡∏ø${safeTotal.toLocaleString()}`;
  const tw = ctx.measureText(totalText).width;
  ctx.fillText(
    totalText,
    canvas.width - cfg.padding - tw,
    y
  );

/* ================= SIGNATURE SECTION ================= */
  const todayText = order.createdAt
   ? new Date(order.createdAt).toLocaleDateString("th-TH")
   : new Date().toLocaleDateString("th-TH");
  y = canvas.height - 200;  // üî• ‡∏•‡πá‡∏≠‡∏Å‡∏ó‡πâ‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤ A4

  const signWidth = 260;

  // LEFT SIGN
  ctx.beginPath();
  ctx.moveTo(cfg.padding, y);
  ctx.lineTo(cfg.padding + signWidth, y);
  ctx.stroke();

  ctx.fillText("‡πÉ‡∏ô‡∏ô‡∏≤‡∏° ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏û‡∏•‡∏±‡∏™ 88 ‡∏à‡∏≥‡∏Å‡∏±‡∏î", cfg.padding, y + 28);
  ctx.fillText("‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏á‡∏ö‡∏¥‡∏•", cfg.padding, y + 56);
  ctx.fillText(`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${todayText}`, cfg.padding, y + 84);

  // RIGHT SIGN
  const rightStart = canvas.width - cfg.padding - signWidth;

  ctx.beginPath();
  ctx.moveTo(rightStart, y);
  ctx.lineTo(canvas.width - cfg.padding, y);
  ctx.stroke();

  ctx.fillText("‡πÉ‡∏ô‡∏ô‡∏≤‡∏° ‡∏£‡πâ‡∏≤‡∏ô‡∏•‡πâ‡∏≠‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå", rightStart, y + 28);
  ctx.fillText("‡∏ú‡∏π‡πâ‡∏ß‡∏≤‡∏á‡∏ö‡∏¥‡∏•", rightStart, y + 56);
  ctx.fillText(`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${todayText}`, rightStart, y + 84);

  /* ================= DOWNLOAD (FIXED) ================= */
  const a = document.createElement("a");
  a.download = `order-${order.orderId}.png`;
  a.href = canvas.toDataURL("image/png");

  // üî¥ FIX: ‡∏ï‡πâ‡∏≠‡∏á append ‡πÄ‡∏Ç‡πâ‡∏≤ DOM (Mobile Safari / Chrome policy)
 document.body.appendChild(a);
 a.click();
 document.body.removeChild(a);
}

function exportOrderPrint() {
  const order = state.lastOrder;
  if (!order) return;

  const items = Array.isArray(order.items) ? order.items : [];

  const po = order.poNumber
    ? String(order.poNumber)
    : "-";

  const today = order.createdAt
    ? new Date(order.createdAt).toLocaleDateString("th-TH")
    : new Date().toLocaleDateString("th-TH");

  const total = Number(order.total || 0).toLocaleString();

  const printWindow = window.open("", "_blank");

  printWindow.document.write(`
    <html>
    <head>
      <title>Order ${order.orderId}</title>
      <style>
        @page {
          size: A4;
          margin: 20mm;
        }

        body {
          font-family: -apple-system, BlinkMacSystemFont, sans-serif;
          font-size: 14px;
          color: #111827; /* Dark Accent */
          margin: 0;

          display: flex;
          flex-direction: column;
          min-height: 100vh;
          }

          .content {
          flex: 1;
        }

        .header {
          display: flex;
          justify-content: space-between;
        }

        .section {
          margin-bottom: 24px;
        }

        h2 {
          color: #1E3A8A; /* Navy Blue */
          margin: 0 0 8px 0;
        }
        
        table {
          width: 100%;
          border-collapse: collapse;
        }

        th, td {
          border-bottom: 1px solid #E5E7EB; /* Soft Gray */
          padding: 8px;
          text-align: left;
        }

        th {
          font-weight: 600;
          background: #F9FAFB; /* very soft header tint */
          color: #1E3A8A; /* Navy Blue */
        }

        .total {
          text-align: right;
          font-weight: bold;
          font-size: 16px;
          margin-top: 16px;
          color: #111827; /* Dark Accent */ 
        }

.sign {
  display: flex;
  justify-content: space-between;
  margin-top: auto;   /* üî• ‡∏´‡∏±‡∏ß‡πÉ‡∏à */
}

        .sign-block {
          width: 40%;
          text-align: center;
        }

        .line {
          border-top: 1px solid #E5E7EB; /* Soft Gray */
          margin-bottom: 8px;
        }

 .top-meta {
   display: flex;
   justify-content: space-between;
   align-items: center;
   font-size: 12px;
   color: #6B7280;
   margin-bottom: 12px;
 }

      </style>
    </head>
    <body>

  <div class="top-meta">
    <div>${new Date().toLocaleString("th-TH", {
  dateStyle: "short",
  timeStyle: "short"
})}
</div>
    <div>Order ${order.orderId}</div>
  </div>

     <div class="content">
     
      <div class="header section">
        <div>
          <h2>‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
          <div>‡∏£‡πâ‡∏≤‡∏ô‡∏•‡πâ‡∏≠‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå</div>
          <div>7/13 ‡∏´‡∏°‡∏π‡πà 5 ‡∏ï.‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏Ç‡∏°</div>
          <div>‡∏≠.‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏Ñ ‡∏à.‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ 18140</div>
        </div>

        <div>
          <div>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${order.orderId}</div>
          <div>PO: ${po}</div>
          <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${today}</div>
        </div>
      </div>

      <div class="section">
        <strong>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong><br>
        ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏û‡∏•‡∏±‡∏™ 88 ‡∏à‡∏≥‡∏Å‡∏±‡∏î<br>
        99 ‡∏´‡∏°‡∏π‡πà 5 ‡∏ï.‡∏´‡πâ‡∏ß‡∏¢‡∏ó‡∏£‡∏≤‡∏¢ ‡∏≠.‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏Ñ<br>
        ‡∏à.‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ 18230<br>
        ‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ 0195566000907
      </div>

      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
            <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
            <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
            <th>‡∏£‡∏ß‡∏°</th>
          </tr>
        </thead>
        <tbody>
          ${items.map((i, index) => `
            <tr>
              <td>${index + 1}</td>
              <td>[${esc(i.productId)}] ${esc(i.name)}</td>
              <td>${i.qty}</td>
              <td>‡∏ø${Number(i.price).toLocaleString()}</td>
              <td>‡∏ø${(i.price * i.qty).toLocaleString()}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>

<div class="total">
  ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ‡∏ø${total}
</div>

</div> <!-- ‡∏õ‡∏¥‡∏î content -->

      <div class="sign">
        <div class="sign-block">
          <div class="line"></div>
          ‡πÉ‡∏ô‡∏ô‡∏≤‡∏° ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏û‡∏•‡∏±‡∏™ 88 ‡∏à‡∏≥‡∏Å‡∏±‡∏î<br>
          ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏á‡∏ö‡∏¥‡∏•<br>
          ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${today}
        </div>

        <div class="sign-block">
          <div class="line"></div>
          ‡πÉ‡∏ô‡∏ô‡∏≤‡∏° ‡∏£‡πâ‡∏≤‡∏ô‡∏•‡πâ‡∏≠‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå<br>
          ‡∏ú‡∏π‡πâ‡∏ß‡∏≤‡∏á‡∏ö‡∏¥‡∏•<br>
          ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${today}
        </div>
      </div>

      <script>
        window.onload = function() {
          window.print();
          window.onafterprint = function() {
            window.close();
          }
        }
      <\/script>

    </body>
    </html>
  `);

  printWindow.document.close();
}
  
function finishAdminAction({ refresh = true } = {}) {
  // üîí ‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å overlay ‡∏ú‡πà‡∏≤‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á (Overlay Manager)
  document.querySelectorAll(".sheet.show, .side-menu.show")
    .forEach(el => {
      closeOverlay(el); // ‚úÖ ‡∏´‡∏±‡∏ß‡πÉ‡∏à
    });

  // ‚ùå ‡∏Å‡∏±‡∏ô Orders ‡πÄ‡∏î‡πâ‡∏á‡∏ã‡πâ‡∏≥
  allowOpenOrders = false;

  // üîç RESET SEARCH (‡∏Å‡∏±‡∏ô filter ‡∏Ñ‡πâ‡∏≤‡∏á)
  state.search = "";

  // üîÑ optional refresh ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  if (refresh) {
    refreshProducts();
  }

  // üîÑ render header ‡πÉ‡∏´‡∏°‡πà (search ‡∏à‡∏∞‡πÇ‡∏•‡πà‡∏á)
  renderHeader();
}

/* ================= GLOBAL INPUT FOCUS FIX ================= */
function focusInput(el) {
  if (!el) return;

  setTimeout(() => {
    try {
      el.scrollIntoView({
        behavior: "smooth",
        block: "center"
      });
    } catch (e) {
      el.scrollIntoView();
    }
  }, 200);
}

function saveAdminSession({ token, username, expiredAt }) {
  localStorage.setItem("admin_session", JSON.stringify({
    token,
    username,
    expiredAt
  }));
}

function loadAdminSession() {
  try {
    return JSON.parse(localStorage.getItem("admin_session"));
  } catch {
    return null;
  }
}

function clearAdminSession() {
  localStorage.removeItem("admin_session");
}

// ================= EMERGENCY UI UNLOCK =================
// ‚ö†Ô∏è DEV / ADMIN USE ONLY
window.forceUnlockUI = function(){
  console.warn('[forceUnlockUI] manual reset');

  // reset flags
  state.isSubmitting = false;
  state.ui.backdropLocked = false;
  state.ui.overlayCount =
    document.querySelectorAll(".sheet.show, .side-menu.show").length;
  // close all overlays
  document
    .querySelectorAll(".sheet.show, .side-menu.show")
    .forEach(el => el.classList.remove("show"));

  // hide loading overlay
  const overlay = document.getElementById("loading-overlay");
  if (overlay) overlay.classList.add("hidden");

  // hide backdrop
  if (backdrop) backdrop.style.display = "none";

  showToast("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "info");
};

async function restoreAdminSessionIfValid() {
  const restored = loadAdminSession();
  if (!restored?.token || !restored?.expiredAt) return false;

  if (Date.now() > new Date(restored.expiredAt).getTime()) {
    clearAdminSession();
    return false;
  }

  try {
    // lightweight validate
    const res = await fetch(
      `${API_URL}?action=orders&token=${restored.token}`
    );
    const json = await res.json();

    if (json?.success === true) {
      state.admin.loggedIn = true;
      state.admin.user = restored.username;
      state.admin.token = restored.token;
      state.admin.expiredAt = restored.expiredAt;
      state.mode = "admin";
      return true;
    }
  } catch (e) {
    console.warn("restore admin failed");
  }

  clearAdminSession();
  return false;
}
  
/* ================= INIT APP (CLEAN / SAFE) ================= */
 /* ================= LIQUID HEADER SCROLL EFFECT ================= */
 let _lastScrollY = 0;
 let _lastScrollTime = performance.now(); // üî¥ NEW: velocity time base
 let _headerTicking = false;

 const VELOCITY_HIDE = 0.6;   // px per ms
 const VELOCITY_SHOW = -0.6;  // px per ms 
 const VELOCITY_DEADZONE = 0.05; // üî¥ NEW: jitter guard 
 
 function handleHeaderScroll(){
   const header = document.getElementById("appHeader");
   const bar    = document.getElementById("floatingBar");
   
   const currentY = Math.max(0, window.scrollY); // üî¥ FIX: clamp negative scroll (iOS bounce)
   const now = performance.now();                       // üî¥ NEW
   const delta = currentY - _lastScrollY;
   const deltaTime = now - _lastScrollTime || 16;      // üî¥ NEW
   const velocity = delta / deltaTime;                 // üî¥ NEW

  // üî¥ NEW: micro scroll noise guard
  if (Math.abs(delta) < 1) {
    _lastScrollY = currentY;
    _lastScrollTime = now;
    _headerTicking = false;
    return;
  }  
   
if (header){
    if (currentY > 10) {
      header.classList.add("scrolled");
    } else {
      header.classList.remove("scrolled");
    }
  }

  /* ================= FLOATING BAR SMART HIDE ================= */
  if (
   bar &&
   bar.classList.contains("show") &&
   state.ui.overlayCount === 0 // üî¥ CHANGED: disable momentum when overlay open
 ) {

    if (currentY <= 10) {
      // üìç ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡∏°‡∏≠
      bar.classList.remove("scroll-hide");
    }
    else if (velocity > VELOCITY_HIDE + VELOCITY_DEADZONE) {
      // ‚¨áÔ∏è scroll ‡∏•‡∏á
      bar.classList.add("scroll-hide");
    }
    else if (velocity < VELOCITY_SHOW - VELOCITY_DEADZONE) {
      // ‚¨ÜÔ∏è scroll ‡∏Ç‡∏∂‡πâ‡∏ô
      bar.classList.remove("scroll-hide");
    }
  }

   _lastScrollY = currentY;
   _lastScrollTime = now; // üî¥ NEW
   _headerTicking = false;
 }

 window.addEventListener("scroll", () => {
   
   if (!_headerTicking) {
     window.requestAnimationFrame(handleHeaderScroll);
     _headerTicking = true;
   }
 });
  
(async () => {
  try {
    state.search = "";

    const restored = loadAdminSession();
    let adminRestored = false;

    if (
      restored &&
      restored.token &&
      restored.expiredAt &&
      Date.now() < new Date(restored.expiredAt).getTime()
    ) {
      try {
        // ‚úÖ FIX: ‡πÉ‡∏ä‡πâ POST ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á backend
        const form = new URLSearchParams();
        form.append("action", "orders");
        form.append("token", restored.token);

        const res = await fetch(API_URL, {
          method: "POST",
          body: form
        });

        const json = await res.json();

        if (json && json.success === true) {
          state.admin.loggedIn = true;
          state.admin.user = restored.username;
          state.admin.token = restored.token;
          state.admin.expiredAt = restored.expiredAt;

          state.mode = "admin";
          adminRestored = true;
        }
      } catch (err) {
        console.warn("Admin session validation failed", err);
      }
    }

    // ‚ùå invalid / expired
    if (!adminRestored) {
      clearAdminSession();
      state.mode = "viewer";
    }

    // ‚úÖ RESTORE VIEWER STATE ‡∏Å‡πà‡∏≠‡∏ô render ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á
    loadCart();

    // ‚úÖ ‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏•‡∏î data ‡∏´‡∏•‡∏±‡∏á‡∏£‡∏π‡πâ mode ‡πÅ‡∏•‡πâ‡∏ß
    await refreshProducts();

    // ‚úÖ RENDER
    renderHeader();
    renderProducts();
    if (typeof renderBadge === "function") {
      renderBadge();
    }

  } catch (err) {
    console.error("[INIT ERROR]", err);
    showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ", "error");
  } finally {
    safeHideLoading();
  }
})();

  
</script>
  
<!-- Toast Container -->
<div id="toast-container"></div>

<!-- Floating Bottom Bar -->
<div id="floatingBar"></div>  

<!-- Loading Overlay -->
<div id="loading-overlay" class="hidden">
  <div class="loading-box">
    <div class="spinner"></div>
    <div id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</div>
  </div>
</div>

  
</body>
</html>
